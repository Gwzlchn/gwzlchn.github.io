

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=light>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" href="/img/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#080000">
  <meta name="author" content="Zelin Wang">
  <meta name="keywords" content="">
  
    <meta name="description" content="1. 用户程序调用 IBVerbs 用户调用的ibv_reg_mr中包含四个参数，如下所示  12struct ibv_mr *ibv_reg_mr(struct ibv_pd *pd, void *addr,                          size_t length, enum ibv_access_flags acces  https:&#x2F;&#x2F;www.rdmamojo.com&#x2F;">
<meta property="og:type" content="article">
<meta property="og:title" content="RDMA-RoCEv2 ibv_reg_mr 分析">
<meta property="og:url" content="https://gwzlchn.github.io/202208/rdma-stack-02/index.html">
<meta property="og:site_name" content="Zelin&#39;s Blog">
<meta property="og:description" content="1. 用户程序调用 IBVerbs 用户调用的ibv_reg_mr中包含四个参数，如下所示  12struct ibv_mr *ibv_reg_mr(struct ibv_pd *pd, void *addr,                          size_t length, enum ibv_access_flags acces  https:&#x2F;&#x2F;www.rdmamojo.com&#x2F;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gwzlchn.github.io/img/rdma-stack-02/get_user_pages.png">
<meta property="article:published_time" content="2022-08-25T03:17:48.000Z">
<meta property="article:modified_time" content="2022-10-16T11:54:57.701Z">
<meta property="article:author" content="Zelin Wang">
<meta property="article:tag" content="RDMA">
<meta property="article:tag" content="libRXE">
<meta property="article:tag" content="Soft-ROCE">
<meta property="article:tag" content="libibverbs">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://gwzlchn.github.io/img/rdma-stack-02/get_user_pages.png">
  
  
  
  <title>RDMA-RoCEv2 ibv_reg_mr 分析 - Zelin&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"gwzlchn.github.io","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"vyfV0Jz8OincT54vffevrlx0-gzGzoHsz","app_key":"abuQhfiaX9zRJg6PYac65qfa","server_url":"https://vyfv0jz8.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 50vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Zelin&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/banner.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="RDMA-RoCEv2 ibv_reg_mr 分析"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-08-25 11:17" pubdate>
          星期四, 八月 25日 2022, 11:17 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          23k 字
        
      </span>
    

    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">RDMA-RoCEv2 ibv_reg_mr 分析</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="1-用户程序调用-IBVerbs"><a href="#1-用户程序调用-IBVerbs" class="headerlink" title="1. 用户程序调用 IBVerbs"></a>1. 用户程序调用 IBVerbs</h2><ol>
<li><p>用户调用的ibv_reg_mr中包含四个参数，如下所示</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">struct</span> ibv_mr *<span class="hljs-title function_">ibv_reg_mr</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ibv_pd *pd, <span class="hljs-type">void</span> *addr,</span><br><span class="hljs-params">                          <span class="hljs-type">size_t</span> length, <span class="hljs-keyword">enum</span> ibv_access_flags acces</span><br></code></pre></td></tr></table></figure>
<p> <a target="_blank" rel="noopener" href="https://www.rdmamojo.com/2012/09/07/ibv_reg_mr/">https://www.rdmamojo.com/2012/09/07/ibv_reg_mr&#x2F;</a></p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Direction</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>pd</td>
<td>in</td>
<td>Protection Domain that was returned from ibv_alloc_pd()</td>
</tr>
<tr>
<td>addr</td>
<td>in</td>
<td>The start address of the virtual contiguous memory block</td>
</tr>
<tr>
<td>length</td>
<td>in</td>
<td>Size of the memory block to register, in bytes. This value must be at least 1 and less than dev_cap.max_mr_size</td>
</tr>
<tr>
<td>access</td>
<td>in</td>
<td>Requested access permissions for the memory region</td>
</tr>
</tbody></table>
</li>
<li><p>在当前的rdma-core实现下，会实际调用ibv_reg_mr_iova2，传入的addr&#x2F;iova两个参数相等</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rdma-core/libibverbs/verbs.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">undef</span> ibv_reg_mr</span><br>LATEST_SYMVER_FUNC(ibv_reg_mr, <span class="hljs-number">1</span>_1, <span class="hljs-string">&quot;IBVERBS_1.1&quot;</span>,<br>		   <span class="hljs-keyword">struct</span> ibv_mr *,<br>		   <span class="hljs-keyword">struct</span> ibv_pd *pd, <span class="hljs-type">void</span> *addr,<br>		   <span class="hljs-type">size_t</span> length, <span class="hljs-type">int</span> access)<br>&#123;<br>	<span class="hljs-keyword">return</span> ibv_reg_mr_iova2(pd, addr, length, (<span class="hljs-type">uintptr_t</span>)addr, access);<br>&#125;<br><br><span class="hljs-keyword">struct</span> ibv_mr *<span class="hljs-title function_">ibv_reg_mr_iova2</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ibv_pd *pd, <span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> length,</span><br><span class="hljs-params">				<span class="hljs-type">uint64_t</span> iova, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> access)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">verbs_device</span> *<span class="hljs-title">device</span> =</span> verbs_get_device(pd-&gt;context-&gt;device);<br>	<span class="hljs-type">bool</span> odp_mr = access &amp; IBV_ACCESS_ON_DEMAND;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ibv_mr</span> *<span class="hljs-title">mr</span>;</span><br><br>	<span class="hljs-keyword">if</span> (!(device-&gt;core_support &amp; IB_UVERBS_CORE_SUPPORT_OPTIONAL_MR_ACCESS))<br>		access &amp;= ~IBV_ACCESS_OPTIONAL_RANGE;<br><br>	<span class="hljs-keyword">if</span> (!odp_mr &amp;&amp; ibv_dontfork_range(addr, length))<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br>	mr = get_ops(pd-&gt;context)-&gt;reg_mr(pd, addr, length, iova, access);<br>	<span class="hljs-keyword">if</span> (mr) &#123;<br>		mr-&gt;context = pd-&gt;context;<br>		mr-&gt;pd      = pd;<br>		mr-&gt;addr    = addr;<br>		mr-&gt;length  = length;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		<span class="hljs-keyword">if</span> (!odp_mr)<br>			ibv_dofork_range(addr, length);<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> mr;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h2 id="2-用户态libRXE"><a href="#2-用户态libRXE" class="headerlink" title="2. 用户态libRXE"></a>2. 用户态libRXE</h2><ol>
<li><p>libRXE中，rxe_reg_mr 函数指针注册为 <code>ops-&gt;reg_mr</code></p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rdma-core/providers/rxe/rxe.c</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">verbs_context_ops</span> <span class="hljs-title">rxe_ctx_ops</span> =</span> &#123;<br>	...<br>	.reg_mr = rxe_reg_mr,<br>	.dereg_mr = rxe_dereg_mr,<br>	.alloc_mw = rxe_alloc_mw,<br>	.dealloc_mw = rxe_dealloc_mw,<br>	.bind_mw = rxe_bind_mw,<br>...<br>&#125;;<br></code></pre></td></tr></table></figure>
</li>
<li><p>rxe_reg_mr 实现</p>
<ul>
<li>申请一个verbs_mr结构体空间</li>
<li>通过ibv_cmd_reg_mr执行系统调用。注意这里 addr 和 hca_va 参数是相等的</li>
</ul>
 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-comment">// rdma-core/providers/rxe/rxe.c</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ibv_mr</span> *<span class="hljs-built_in">rxe_reg_mr</span>(<span class="hljs-keyword">struct</span> ibv_pd *pd, <span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> length,<br>				 <span class="hljs-type">uint64_t</span> hca_va, <span class="hljs-type">int</span> access)<br>&#123;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">verbs_mr</span> *vmr;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ibv_reg_mr</span> cmd;<br>	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ib_uverbs_reg_mr_resp</span> resp;<br>	<span class="hljs-type">int</span> ret;<br><br>	vmr = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">sizeof</span>(*vmr));<br>	<span class="hljs-keyword">if</span> (!vmr)<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br>	ret = <span class="hljs-built_in">ibv_cmd_reg_mr</span>(pd, addr, length, hca_va, access, vmr, &amp;cmd,<br>			     <span class="hljs-built_in">sizeof</span>(cmd), &amp;resp, <span class="hljs-built_in">sizeof</span>(resp));<br>	<span class="hljs-keyword">if</span> (ret) &#123;<br>		<span class="hljs-built_in">free</span>(vmr);<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">return</span> &amp;vmr-&gt;ibv_mr;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h2 id="3-发起write系统调用"><a href="#3-发起write系统调用" class="headerlink" title="3. 发起write系统调用"></a>3. 发起write系统调用</h2><ol>
<li>ibv_cmd_reg_mr 实现<ul>
<li>将传入参数写入到cmd结构体中</li>
<li>发起write系统调用， 发起的cmd名称为 IB_USER_VERBS_CMD_REG_MR</li>
</ul>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rdma-core/libibverbs/cmd.c</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">ibv_cmd_reg_mr</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ibv_pd *pd, <span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> length,</span><br><span class="hljs-params">		   <span class="hljs-type">uint64_t</span> hca_va, <span class="hljs-type">int</span> access,</span><br><span class="hljs-params">		   <span class="hljs-keyword">struct</span> verbs_mr *vmr, <span class="hljs-keyword">struct</span> ibv_reg_mr *cmd,</span><br><span class="hljs-params">		   <span class="hljs-type">size_t</span> cmd_size,</span><br><span class="hljs-params">		   <span class="hljs-keyword">struct</span> ib_uverbs_reg_mr_resp *resp, <span class="hljs-type">size_t</span> resp_size)</span><br>&#123;<br>	<span class="hljs-type">int</span> ret;<br><br>	cmd-&gt;start 	  = (<span class="hljs-type">uintptr_t</span>) addr;<br>	cmd-&gt;length 	  = length;<br>	<span class="hljs-comment">/* On demand access and entire address space means implicit.</span><br><span class="hljs-comment">	 * In that case set the value in the command to what kernel expects.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (access &amp; IBV_ACCESS_ON_DEMAND) &#123;<br>		<span class="hljs-keyword">if</span> (length == SIZE_MAX &amp;&amp; addr) &#123;<br>			errno = EINVAL;<br>			<span class="hljs-keyword">return</span> EINVAL;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (length == SIZE_MAX)<br>			cmd-&gt;length = UINT64_MAX;<br>	&#125;<br><br>	cmd-&gt;hca_va 	  = hca_va;<br>	cmd-&gt;pd_handle 	  = pd-&gt;handle;<br>	cmd-&gt;access_flags = access;<br><br>	ret = execute_cmd_write(pd-&gt;context, IB_USER_VERBS_CMD_REG_MR, cmd,<br>				cmd_size, resp, resp_size);<br>	<span class="hljs-keyword">if</span> (ret)<br>		<span class="hljs-keyword">return</span> ret;<br><br>	vmr-&gt;ibv_mr.handle  = resp-&gt;mr_handle;<br>	vmr-&gt;ibv_mr.lkey    = resp-&gt;lkey;<br>	vmr-&gt;ibv_mr.rkey    = resp-&gt;rkey;<br>	vmr-&gt;ibv_mr.context = pd-&gt;context;<br>	vmr-&gt;mr_type        = IBV_MR_TYPE_MR;<br>	vmr-&gt;access = access;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>这里补充下 ib_uverbs_reg_mr 系统调用传入的结构体，以及 ib_uverbs_reg_mr_resp 传回结构体</li>
</ul>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ib_uverbs_reg_mr</span> &#123;</span><br>	__aligned_u64 response;<br>	__aligned_u64 start;<br>	__aligned_u64 length;<br>	__aligned_u64 hca_va;<br>	__u32 pd_handle;<br>	__u32 access_flags;<br>	__aligned_u64 driver_data[<span class="hljs-number">0</span>];<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ib_uverbs_reg_mr_resp</span> &#123;</span><br>	__u32 mr_handle;<br>	__u32 lkey;<br>	__u32 rkey;<br>	__u32 driver_data[<span class="hljs-number">0</span>];<br>&#125;;<br></code></pre></td></tr></table></figure></li>
</ol>
<h2 id="4-内核中rdma-core处理系统调用"><a href="#4-内核中rdma-core处理系统调用" class="headerlink" title="4. 内核中rdma-core处理系统调用"></a>4. 内核中rdma-core处理系统调用</h2><ol>
<li><p>IB_USER_VERBS_CMD_REG_MR 方法的write系统调用，由 ib_uverbs_reg_mr 函数处理</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel/drivers/infiniband/core/uverbs_cmd.c</span><br>DECLARE_UVERBS_WRITE(<br>			IB_USER_VERBS_CMD_REG_MR,<br>			ib_uverbs_reg_mr,<br>			UAPI_DEF_WRITE_UDATA_IO(<span class="hljs-keyword">struct</span> ib_uverbs_reg_mr,<br>						<span class="hljs-keyword">struct</span> ib_uverbs_reg_mr_resp),<br>			UAPI_DEF_METHOD_NEEDS_FN(reg_user_mr)),<br></code></pre></td></tr></table></figure>
</li>
<li><p>ib_uverbs_reg_mr 实现</p>
<ul>
<li>取出传入的ib_uverbs_reg_mr结构体，这里检查 cmd.start 和 cmd.hca_va 两个地址是否相等</li>
<li>执行实际的 reg_user_mr 函数</li>
</ul>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel/drivers/infiniband/core/uverbs_cmd.c</span><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">ib_uverbs_reg_mr</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> uverbs_attr_bundle *attrs)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ib_uverbs_reg_mr_resp</span> <span class="hljs-title">resp</span> =</span> &#123;&#125;;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ib_uverbs_reg_mr</span>      <span class="hljs-title">cmd</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ib_uobject</span>           *<span class="hljs-title">uobj</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ib_pd</span>                *<span class="hljs-title">pd</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ib_mr</span>                *<span class="hljs-title">mr</span>;</span><br>	<span class="hljs-type">int</span>                          ret;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ib_device</span> *<span class="hljs-title">ib_dev</span>;</span><br><br>	ret = uverbs_request(attrs, &amp;cmd, <span class="hljs-keyword">sizeof</span>(cmd));<br>	<span class="hljs-keyword">if</span> (ret)<br>		<span class="hljs-keyword">return</span> ret;<br><br>	<span class="hljs-keyword">if</span> ((cmd.start &amp; ~PAGE_MASK) != (cmd.hca_va &amp; ~PAGE_MASK))<br>		<span class="hljs-keyword">return</span> -EINVAL;<br><br>	uobj = uobj_alloc(UVERBS_OBJECT_MR, attrs, &amp;ib_dev);<br>	<span class="hljs-keyword">if</span> (IS_ERR(uobj))<br>		<span class="hljs-keyword">return</span> PTR_ERR(uobj);<br><br>	ret = ib_check_mr_access(ib_dev, cmd.access_flags);<br>	<span class="hljs-keyword">if</span> (ret)<br>		<span class="hljs-keyword">goto</span> err_free;<br><br>	pd = uobj_get_obj_read(pd, UVERBS_OBJECT_PD, cmd.pd_handle, attrs);<br>	<span class="hljs-keyword">if</span> (!pd) &#123;<br>		ret = -EINVAL;<br>		<span class="hljs-keyword">goto</span> err_free;<br>	&#125;<br><br>	mr = pd-&gt;device-&gt;ops.reg_user_mr(pd, cmd.start, cmd.length, cmd.hca_va,<br>					 cmd.access_flags,<br>					 &amp;attrs-&gt;driver_udata);<br>	<span class="hljs-keyword">if</span> (IS_ERR(mr)) &#123;<br>		ret = PTR_ERR(mr);<br>		<span class="hljs-keyword">goto</span> err_put;<br>	&#125;<br><br>	mr-&gt;device  = pd-&gt;device;<br>	mr-&gt;pd      = pd;<br>	mr-&gt;type    = IB_MR_TYPE_USER;<br>	mr-&gt;dm	    = <span class="hljs-literal">NULL</span>;<br>	mr-&gt;sig_attrs = <span class="hljs-literal">NULL</span>;<br>	mr-&gt;uobject = uobj;<br>	<span class="hljs-type">atomic_inc</span>(&amp;pd-&gt;usecnt);<br>	mr-&gt;iova = cmd.hca_va;<br><br>	rdma_restrack_new(&amp;mr-&gt;res, RDMA_RESTRACK_MR);<br>	rdma_restrack_set_name(&amp;mr-&gt;res, <span class="hljs-literal">NULL</span>);<br>	rdma_restrack_add(&amp;mr-&gt;res);<br><br>	uobj-&gt;object = mr;<br>	uobj_put_obj_read(pd);<br>	uobj_finalize_uobj_create(uobj, attrs);<br><br>	resp.lkey = mr-&gt;lkey;<br>	resp.rkey = mr-&gt;rkey;<br>	resp.mr_handle = uobj-&gt;id;<br>	<span class="hljs-keyword">return</span> uverbs_response(attrs, &amp;resp, <span class="hljs-keyword">sizeof</span>(resp));<br><br>err_put:<br>	uobj_put_obj_read(pd);<br>err_free:<br>	uobj_alloc_abort(uobj, attrs);<br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h2 id="5-RXE内核模块中进行实际的Memory-Region注册"><a href="#5-RXE内核模块中进行实际的Memory-Region注册" class="headerlink" title="5. RXE内核模块中进行实际的Memory Region注册"></a>5. RXE内核模块中进行实际的Memory Region注册</h2><ol>
<li><p>reg_user_mr 函数的注册</p>
<ul>
<li>由此可知，RXE内核模块中实际上调用了 rxe_reg_user_mr 进行MR的注册</li>
</ul>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel/drivers/infiniband/sw/rxe/rxe_verbs.c</span><br><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ib_device_ops</span> <span class="hljs-title">rxe_dev_ops</span> =</span> &#123;<br>	.owner = THIS_MODULE,<br>	.driver_id = RDMA_DRIVER_RXE,<br>	.uverbs_abi_ver = RXE_UVERBS_ABI_VERSION,<br>...<br>	.alloc_mr = rxe_alloc_mr,<br>	.alloc_mw = rxe_alloc_mw,<br>...<br>	.dealloc_mw = rxe_dealloc_mw,<br>...<br>	.dereg_mr = rxe_dereg_mr,<br>...<br>	.get_dma_mr = rxe_get_dma_mr,<br>...<br>	.map_mr_sg = rxe_map_mr_sg,<br>...<br>	.reg_user_mr = rxe_reg_user_mr,<br>...<br>&#125;;<br></code></pre></td></tr></table></figure>
</li>
<li><p>rxe_reg_user_mr 的实现</p>
<ul>
<li>参数 start&#x2F;iova 即为 Memory region的起始地址，length 为其长度</li>
<li><code>rxe_alloc</code> 在<code>rxe-&gt;mr_pool</code>中申请一个rxe_mr struct 空间</li>
<li>调用 <code>rxe_mr_init_user</code>, 传入的 mr 结构体指针刚申请空间，无实际内容</li>
</ul>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel/drivers/infiniband/sw/rxe/rxe_verbs.c</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> ib_mr *<span class="hljs-title function_">rxe_reg_user_mr</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ib_pd *ibpd,</span><br><span class="hljs-params">				     u64 start,</span><br><span class="hljs-params">				     u64 length,</span><br><span class="hljs-params">				     u64 iova,</span><br><span class="hljs-params">				     <span class="hljs-type">int</span> access, <span class="hljs-keyword">struct</span> ib_udata *udata)</span><br>&#123;<br>	<span class="hljs-type">int</span> err;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_dev</span> *<span class="hljs-title">rxe</span> =</span> to_rdev(ibpd-&gt;device);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_pd</span> *<span class="hljs-title">pd</span> =</span> to_rpd(ibpd);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_mr</span> *<span class="hljs-title">mr</span>;</span><br><br>	mr = rxe_alloc(&amp;rxe-&gt;mr_pool);<br>	<span class="hljs-keyword">if</span> (!mr) &#123;<br>		err = -ENOMEM;<br>		<span class="hljs-keyword">goto</span> err2;<br>	&#125;<br><br>	rxe_get(pd);<br><br>	err = rxe_mr_init_user(pd, start, length, iova, access, mr);<br>	<span class="hljs-keyword">if</span> (err)<br>		<span class="hljs-keyword">goto</span> err3;<br><br>	<span class="hljs-keyword">return</span> &amp;mr-&gt;ibmr;<br><br>err3:<br>	rxe_put(pd);<br>	rxe_put(mr);<br>err2:<br>	<span class="hljs-keyword">return</span> ERR_PTR(err);<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>rxe_mr_init_user的实现</p>
<ol>
<li>调用 ib_umem_get 来完成内存页面pin操作 + 将pin住的内存页面组织为DMA SG List</li>
<li>将 ib_umem 中的DMA SG List复制为  rxe_map_set</li>
</ol>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel/drivers/infiniband/sw/rxe/rxe_mr.c</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">rxe_mr_init_user</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rxe_pd *pd, u64 start, u64 length, u64 iova,</span><br><span class="hljs-params">		     <span class="hljs-type">int</span> access, <span class="hljs-keyword">struct</span> rxe_mr *mr)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_map_set</span>	*<span class="hljs-title">set</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_map</span>		**<span class="hljs-title">map</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_phys_buf</span>	*<span class="hljs-title">buf</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ib_umem</span>		*<span class="hljs-title">umem</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sg_page_iter</span>	<span class="hljs-title">sg_iter</span>;</span><br>	<span class="hljs-type">int</span>			num_buf;<br>	<span class="hljs-type">void</span>			*vaddr;<br>	<span class="hljs-type">int</span> err;<br><br>	umem = ib_umem_get(pd-&gt;ibpd.device, start, length, access);<br>	<span class="hljs-keyword">if</span> (IS_ERR(umem)) &#123;<br>		pr_warn(<span class="hljs-string">&quot;%s: Unable to pin memory region err = %d\n&quot;</span>,<br>			__func__, (<span class="hljs-type">int</span>)PTR_ERR(umem));<br>		err = PTR_ERR(umem);<br>		<span class="hljs-keyword">goto</span> err_out;<br>	&#125;<br><br>	num_buf = ib_umem_num_pages(umem);<br><br>	rxe_mr_init(access, mr);<br><br>	err = rxe_mr_alloc(mr, num_buf, <span class="hljs-number">0</span>);<br>	<span class="hljs-keyword">if</span> (err) &#123;<br>		pr_warn(<span class="hljs-string">&quot;%s: Unable to allocate memory for map\n&quot;</span>,<br>				__func__);<br>		<span class="hljs-keyword">goto</span> err_release_umem;<br>	&#125;<br><br>	<span class="hljs-built_in">set</span> = mr-&gt;cur_map_set;<br>	<span class="hljs-built_in">set</span>-&gt;page_shift = PAGE_SHIFT;<br>	<span class="hljs-built_in">set</span>-&gt;page_mask = PAGE_SIZE - <span class="hljs-number">1</span>;<br><br>	num_buf = <span class="hljs-number">0</span>;<br>	<span class="hljs-built_in">map</span> = <span class="hljs-built_in">set</span>-&gt;<span class="hljs-built_in">map</span>;<br><br>	<span class="hljs-keyword">if</span> (length &gt; <span class="hljs-number">0</span>) &#123;<br>		buf = <span class="hljs-built_in">map</span>[<span class="hljs-number">0</span>]-&gt;buf;<br><br>		for_each_sgtable_page (&amp;umem-&gt;sgt_append.sgt, &amp;sg_iter, <span class="hljs-number">0</span>) &#123;<br>			<span class="hljs-keyword">if</span> (num_buf &gt;= RXE_BUF_PER_MAP) &#123;<br>				<span class="hljs-built_in">map</span>++;<br>				buf = <span class="hljs-built_in">map</span>[<span class="hljs-number">0</span>]-&gt;buf;<br>				num_buf = <span class="hljs-number">0</span>;<br>			&#125;<br><br>			vaddr = page_address(sg_page_iter_page(&amp;sg_iter));<br>			<span class="hljs-keyword">if</span> (!vaddr) &#123;<br>				pr_warn(<span class="hljs-string">&quot;%s: Unable to get virtual address\n&quot;</span>,<br>						__func__);<br>				err = -ENOMEM;<br>				<span class="hljs-keyword">goto</span> err_release_umem;<br>			&#125;<br><br>			buf-&gt;addr = (<span class="hljs-type">uintptr_t</span>)vaddr;<br>			buf-&gt;size = PAGE_SIZE;<br>			num_buf++;<br>			buf++;<br>		&#125;<br>	&#125;<br><br>	mr-&gt;ibmr.pd = &amp;pd-&gt;ibpd;<br>	mr-&gt;umem = umem;<br>	mr-&gt;access = access;<br>	mr-&gt;state = RXE_MR_STATE_VALID;<br>	mr-&gt;type = IB_MR_TYPE_USER;<br><br>	<span class="hljs-built_in">set</span>-&gt;length = length;<br>	<span class="hljs-built_in">set</span>-&gt;iova = iova;<br>	<span class="hljs-built_in">set</span>-&gt;va = start;<br>	<span class="hljs-built_in">set</span>-&gt;offset = ib_umem_offset(umem);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>err_release_umem:<br>	ib_umem_release(umem);<br>err_out:<br>	<span class="hljs-keyword">return</span> err;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>ib_umem_get的实现</p>
<ul>
<li>ib_umem 结构体记录传入的起始地址&#x2F;长度，以及当前用户线程的 mm_struct</li>
<li>将 addr 开始的 npages 个页面pin在内存中</li>
<li><code>pin_user_pages_fast</code><ul>
<li>参考： <a target="_blank" rel="noopener" href="https://lwn.net/Articles/807108/">Explicit pinning of user-space pages</a></li>
</ul>
</li>
<li>将被pin住的n个页面，组织为DMA SG List，保存在 umem -&gt;sgt_append 中<ul>
<li>调用 sg_alloc_append_table_from_pages 来实现这个目的</li>
</ul>
</li>
</ul>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel/drivers/infiniband/core/umem.c</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ib_umem_get - Pin and DMA map userspace memory.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @device: IB device to connect UMEM</span><br><span class="hljs-comment"> * @addr: userspace virtual address to start at</span><br><span class="hljs-comment"> * @size: length of region to pin</span><br><span class="hljs-comment"> * @access: IB_ACCESS_xxx flags for memory being pinned</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">struct</span> ib_umem *<span class="hljs-title function_">ib_umem_get</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ib_device *device, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr,</span><br><span class="hljs-params">			    <span class="hljs-type">size_t</span> size, <span class="hljs-type">int</span> access)</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ib_umem</span> *<span class="hljs-title">umem</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> **<span class="hljs-title">page_list</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> lock_limit;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> new_pinned;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> cur_base;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> dma_attr = <span class="hljs-number">0</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span>;</span><br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> npages;<br>	<span class="hljs-type">int</span> pinned, ret;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> gup_flags = FOLL_WRITE;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If the combination of the addr and size requested for this memory</span><br><span class="hljs-comment">	 * region causes an integer overflow, return error.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (((addr + size) &lt; addr) ||<br>	    PAGE_ALIGN(addr + size) &lt; (addr + size))<br>		<span class="hljs-keyword">return</span> ERR_PTR(-EINVAL);<br><br>	<span class="hljs-keyword">if</span> (!can_do_mlock())<br>		<span class="hljs-keyword">return</span> ERR_PTR(-EPERM);<br><br>	<span class="hljs-keyword">if</span> (access &amp; IB_ACCESS_ON_DEMAND)<br>		<span class="hljs-keyword">return</span> ERR_PTR(-EOPNOTSUPP);<br><br>	umem = kzalloc(<span class="hljs-keyword">sizeof</span>(*umem), GFP_KERNEL);<br>	<span class="hljs-keyword">if</span> (!umem)<br>		<span class="hljs-keyword">return</span> ERR_PTR(-ENOMEM);<br>	umem-&gt;ibdev      = device;<br>	umem-&gt;length     = size;<br>	umem-&gt;address    = addr;<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Drivers should call ib_umem_find_best_pgsz() to set the iova</span><br><span class="hljs-comment">	 * correctly.</span><br><span class="hljs-comment">	 */</span><br>	umem-&gt;iova = addr;<br>	umem-&gt;writable   = ib_access_writable(access);<br>	umem-&gt;owning_mm = mm = current-&gt;mm;<br>	mmgrab(mm);<br><br>	page_list = (<span class="hljs-keyword">struct</span> page **) __get_free_page(GFP_KERNEL);<br>	<span class="hljs-keyword">if</span> (!page_list) &#123;<br>		ret = -ENOMEM;<br>		<span class="hljs-keyword">goto</span> umem_kfree;<br>	&#125;<br><br>	npages = ib_umem_num_pages(umem);<br>	<span class="hljs-keyword">if</span> (npages == <span class="hljs-number">0</span> || npages &gt; UINT_MAX) &#123;<br>		ret = -EINVAL;<br>		<span class="hljs-keyword">goto</span> out;<br>	&#125;<br><br>	lock_limit = rlimit(RLIMIT_MEMLOCK) &gt;&gt; PAGE_SHIFT;<br><br>	new_pinned = atomic64_add_return(npages, &amp;mm-&gt;pinned_vm);<br>	<span class="hljs-keyword">if</span> (new_pinned &gt; lock_limit &amp;&amp; !capable(CAP_IPC_LOCK)) &#123;<br>		atomic64_sub(npages, &amp;mm-&gt;pinned_vm);<br>		ret = -ENOMEM;<br>		<span class="hljs-keyword">goto</span> out;<br>	&#125;<br><br>	cur_base = addr &amp; PAGE_MASK;<br><br>	<span class="hljs-keyword">if</span> (!umem-&gt;writable)<br>		gup_flags |= FOLL_FORCE;<br><br>	<span class="hljs-keyword">while</span> (npages) &#123;<br>		cond_resched();<br>		pinned = pin_user_pages_fast(cur_base,<br>					  <span class="hljs-type">min_t</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>, npages,<br>						PAGE_SIZE /<br>						<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> page *)),<br>					  gup_flags | FOLL_LONGTERM, page_list);<br>		<span class="hljs-keyword">if</span> (pinned &lt; <span class="hljs-number">0</span>) &#123;<br>			ret = pinned;<br>			<span class="hljs-keyword">goto</span> umem_release;<br>		&#125;<br><br>		cur_base += pinned * PAGE_SIZE;<br>		npages -= pinned;<br>		ret = sg_alloc_append_table_from_pages(<br>			&amp;umem-&gt;sgt_append, page_list, pinned, <span class="hljs-number">0</span>,<br>			pinned &lt;&lt; PAGE_SHIFT, ib_dma_max_seg_size(device),<br>			npages, GFP_KERNEL);<br>		<span class="hljs-keyword">if</span> (ret) &#123;<br>			unpin_user_pages_dirty_lock(page_list, pinned, <span class="hljs-number">0</span>);<br>			<span class="hljs-keyword">goto</span> umem_release;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (access &amp; IB_ACCESS_RELAXED_ORDERING)<br>		dma_attr |= DMA_ATTR_WEAK_ORDERING;<br><br>	ret = ib_dma_map_sgtable_attrs(device, &amp;umem-&gt;sgt_append.sgt,<br>				       DMA_BIDIRECTIONAL, dma_attr);<br>	<span class="hljs-keyword">if</span> (ret)<br>		<span class="hljs-keyword">goto</span> umem_release;<br>	<span class="hljs-keyword">goto</span> out;<br><br>umem_release:<br>	__ib_umem_release(device, umem, <span class="hljs-number">0</span>);<br>	atomic64_sub(ib_umem_num_pages(umem), &amp;mm-&gt;pinned_vm);<br>out:<br>	free_page((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) page_list);<br>umem_kfree:<br>	<span class="hljs-keyword">if</span> (ret) &#123;<br>		mmdrop(umem-&gt;owning_mm);<br>		kfree(umem);<br>	&#125;<br>	<span class="hljs-keyword">return</span> ret ? ERR_PTR(ret) : umem;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h2 id="6-Kernel-中关于pin-memory页面相关流程"><a href="#6-Kernel-中关于pin-memory页面相关流程" class="headerlink" title="6. Kernel 中关于pin memory页面相关流程"></a>6. Kernel 中关于pin memory页面相关流程</h2><ol>
<li><p>整体思路</p>
<ul>
<li>保证N个虚拟地址连续的页面被分配，将每个物理页面的引用计数增大到 GUP_PIN_COUNTING_BIAS</li>
<li>page-&gt;refcount 被置为 GUP_PIN_COUNTING_BIAS 表示该页因为DMA的原因而被PIN住。（bit 10位为1）</li>
</ul>
</li>
<li><p>入口函数：pin_user_pages_fast</p>
<p> 从start开始的虚拟地址，pin住 nr_pages 个数的页面，每个页面的指针保存在 pages 数组中传回</p>
<p> 内核相关文档： <a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/core-api/pin_user_pages.html"><strong><strong>pin_user_pages() and related calls</strong></strong></a></p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel/mm/gup.c</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * pin_user_pages_fast() - pin user pages in memory without taking locks</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @start:      starting user address</span><br><span class="hljs-comment"> * @nr_pages:   number of pages from start to pin</span><br><span class="hljs-comment"> * @gup_flags:  flags modifying pin behaviour</span><br><span class="hljs-comment"> * @pages:      array that receives pointers to the pages pinned.</span><br><span class="hljs-comment"> *              Should be at least nr_pages long.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Nearly the same as get_user_pages_fast(), except that FOLL_PIN is set. See</span><br><span class="hljs-comment"> * get_user_pages_fast() for documentation on the function arguments, because</span><br><span class="hljs-comment"> * the arguments here are identical.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * FOLL_PIN means that the pages must be released via unpin_user_page(). Please</span><br><span class="hljs-comment"> * see Documentation/core-api/pin_user_pages.rst for further details.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">pin_user_pages_fast</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start, <span class="hljs-type">int</span> nr_pages,</span><br><span class="hljs-params">			<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> gup_flags, <span class="hljs-keyword">struct</span> page **pages)</span><br>&#123;<br>	<span class="hljs-comment">/* FOLL_GET and FOLL_PIN are mutually exclusive. */</span><br>	<span class="hljs-keyword">if</span> (WARN_ON_ONCE(gup_flags &amp; FOLL_GET))<br>		<span class="hljs-keyword">return</span> -EINVAL;<br><br>	<span class="hljs-keyword">if</span> (WARN_ON_ONCE(!pages))<br>		<span class="hljs-keyword">return</span> -EINVAL;<br><br>	gup_flags |= FOLL_PIN;<br>	<span class="hljs-keyword">return</span> internal_get_user_pages_fast(start, nr_pages, gup_flags, pages);<br>&#125;<br>EXPORT_SYMBOL_GPL(pin_user_pages_fast);<br></code></pre></td></tr></table></figure>
</li>
<li><p>internal_get_user_pages_fast 函数分析</p>
<ul>
<li><p><code>current-&gt;mm-&gt;flags</code> 增加一个bit： MMF_HAS_PINNED</p>
</li>
<li><p>快速路径：页面已经分配出来</p>
<ul>
<li><p>模拟TLB miss情况，通过wake page table 最终分析出PTE entry中是否对应物理页，调用过程如下：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">lockless_pages_from_mm<br>	-- gup_pgd_range<br>		 -- gup_pud_range<br>        -- gup_pud_range<br>           -- gup_pmd_range<br>              -- gup_pte_range<br>                 -- try_grab_folio(page, <span class="hljs-number">1</span>, flags); <span class="hljs-comment">// 这里会对page refcount + GUP_PIN_COUNTING_BIAS - 1</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>慢速路径：可能存在一些未建立映射的页面</p>
<ul>
<li>__get_user_pages</li>
</ul>
</li>
</ul>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">internal_get_user_pages_fast</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start,</span><br><span class="hljs-params">					<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nr_pages,</span><br><span class="hljs-params">					<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> gup_flags,</span><br><span class="hljs-params">					<span class="hljs-keyword">struct</span> page **pages)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len, end;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nr_pinned;<br>	<span class="hljs-type">int</span> ret;<br><br>	<span class="hljs-keyword">if</span> (WARN_ON_ONCE(gup_flags &amp; ~(FOLL_WRITE | FOLL_LONGTERM |<br>				       FOLL_FORCE | FOLL_PIN | FOLL_GET |<br>				       FOLL_FAST_ONLY | FOLL_NOFAULT)))<br>		<span class="hljs-keyword">return</span> -EINVAL;<br><br>	<span class="hljs-keyword">if</span> (gup_flags &amp; FOLL_PIN)<br>		mm_set_has_pinned_flag(&amp;current-&gt;mm-&gt;flags);<br><br>	<span class="hljs-keyword">if</span> (!(gup_flags &amp; FOLL_FAST_ONLY))<br>		might_lock_read(&amp;current-&gt;mm-&gt;mmap_lock);<br><br>	start = untagged_addr(start) &amp; PAGE_MASK;<br>	len = nr_pages &lt;&lt; PAGE_SHIFT;<br>	<span class="hljs-keyword">if</span> (check_add_overflow(start, len, &amp;end))<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">if</span> (unlikely(!access_ok((<span class="hljs-type">void</span> __user *)start, len)))<br>		<span class="hljs-keyword">return</span> -EFAULT;<br><br>	nr_pinned = lockless_pages_from_mm(start, end, gup_flags, pages);<br>	<span class="hljs-keyword">if</span> (nr_pinned == nr_pages || gup_flags &amp; FOLL_FAST_ONLY)<br>		<span class="hljs-keyword">return</span> nr_pinned;<br><br>	<span class="hljs-comment">/* Slow path: try to get the remaining pages with get_user_pages */</span><br>	start += nr_pinned &lt;&lt; PAGE_SHIFT;<br>	pages += nr_pinned;<br>	ret = __gup_longterm_unlocked(start, nr_pages - nr_pinned, gup_flags,<br>				      pages);<br>	<span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) &#123;<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * The caller has to unpin the pages we already pinned so</span><br><span class="hljs-comment">		 * returning -errno is not an option</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (nr_pinned)<br>			<span class="hljs-keyword">return</span> nr_pinned;<br>		<span class="hljs-keyword">return</span> ret;<br>	&#125;<br>	<span class="hljs-keyword">return</span> ret + nr_pinned;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>快速路径：软件模拟TLB走页，把遍历到的每一个页面的page-&gt;refcount 增加 GUP_PIN_COUNTING_BIAS - 1</p>
<ul>
<li>五级页表下模拟TLB功能</li>
<li>五级页表相关参考<ul>
<li><strong><strong><a target="_blank" rel="noopener" href="https://tinylab.org/lwn-717293/">LWN 717293: 五级页表</a></strong></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://lwn.net/Articles/717293/">Five-level page tables</a></strong></li>
</ul>
</li>
</ul>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-title function_">lockless_pages_from_mm</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start,</span><br><span class="hljs-params">					    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> end,</span><br><span class="hljs-params">					    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> gup_flags,</span><br><span class="hljs-params">					    <span class="hljs-keyword">struct</span> page **pages)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;<br>	<span class="hljs-type">int</span> nr_pinned = <span class="hljs-number">0</span>;<br>	<span class="hljs-type">unsigned</span> seq;<br><br>	<span class="hljs-keyword">if</span> (!IS_ENABLED(CONFIG_HAVE_FAST_GUP) ||<br>	    !gup_fast_permitted(start, end))<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>	<span class="hljs-keyword">if</span> (gup_flags &amp; FOLL_PIN) &#123;<br>		seq = raw_read_seqcount(&amp;current-&gt;mm-&gt;write_protect_seq);<br>		<span class="hljs-keyword">if</span> (seq &amp; <span class="hljs-number">1</span>)<br>			<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	&#125;<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * Disable interrupts. The nested form is used, in order to allow full,</span><br><span class="hljs-comment">	 * general purpose use of this routine.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * With interrupts disabled, we block page table pages from being freed</span><br><span class="hljs-comment">	 * from under us. See struct mmu_table_batch comments in</span><br><span class="hljs-comment">	 * include/asm-generic/tlb.h for more details.</span><br><span class="hljs-comment">	 *</span><br><span class="hljs-comment">	 * We do not adopt an rcu_read_lock() here as we also want to block IPIs</span><br><span class="hljs-comment">	 * that come from THPs splitting.</span><br><span class="hljs-comment">	 */</span><br>	local_irq_save(flags);<br>	gup_pgd_range(start, end, gup_flags, pages, &amp;nr_pinned);<br>	local_irq_restore(flags);<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * When pinning pages for DMA there could be a concurrent write protect</span><br><span class="hljs-comment">	 * from fork() via copy_page_range(), in this case always fail fast GUP.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (gup_flags &amp; FOLL_PIN) &#123;<br>		<span class="hljs-keyword">if</span> (read_seqcount_retry(&amp;current-&gt;mm-&gt;write_protect_seq, seq)) &#123;<br>			unpin_user_pages_lockless(pages, nr_pinned);<br>			<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>		&#125; <span class="hljs-keyword">else</span> &#123;<br>			sanity_check_pinned_pages(pages, nr_pinned);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> nr_pinned;<br>&#125;<br></code></pre></td></tr></table></figure>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">gup_pgd_range</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> end,</span><br><span class="hljs-params">		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags, <span class="hljs-keyword">struct</span> page **pages, <span class="hljs-type">int</span> *nr)</span><br>&#123;<br>	<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> next;<br>	<span class="hljs-type">pgd_t</span> *pgdp;<br><br>	pgdp = pgd_offset(current-&gt;mm, addr);<br>	<span class="hljs-keyword">do</span> &#123;<br>		<span class="hljs-type">pgd_t</span> pgd = READ_ONCE(*pgdp);<br><br>		next = pgd_addr_end(addr, end);<br>		<span class="hljs-keyword">if</span> (pgd_none(pgd))<br>			<span class="hljs-keyword">return</span>;<br>		<span class="hljs-keyword">if</span> (unlikely(pgd_huge(pgd))) &#123;<br>			<span class="hljs-keyword">if</span> (!gup_huge_pgd(pgd, pgdp, addr, next, flags,<br>					  pages, nr))<br>				<span class="hljs-keyword">return</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (unlikely(is_hugepd(__hugepd(pgd_val(pgd))))) &#123;<br>			<span class="hljs-keyword">if</span> (!gup_huge_pd(__hugepd(pgd_val(pgd)), addr,<br>					 PGDIR_SHIFT, next, flags, pages, nr))<br>				<span class="hljs-keyword">return</span>;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!gup_p4d_range(pgdp, pgd, addr, next, flags, pages, nr))<br>			<span class="hljs-keyword">return</span>;<br>	&#125; <span class="hljs-keyword">while</span> (pgdp++, addr = next, addr != end);<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>慢速路径：</p>
<ol>
<li><p>__get_user_pages：start对应的虚拟地址连续分配nr_pages个物理内存，核心处理思想就是强制显示手动触发page fault流程为其分配物理page，根据其start所属的vma类型处理主要分几种情况处理：</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://zhikunhuo.blog.csdn.net/article/details/121620769"> 逻辑图示：</a></p>
<p> <img src="/img/rdma-stack-02/get_user_pages.png" srcset="/img/loading.gif" lazyload alt="get_user_pages function"></p>
</li>
<li><p>流程讲解：这里参考了 <a target="_blank" rel="noopener" href="https://zhikunhuo.blog.csdn.net/article/details/121620769">linux那些事之pin memory(get_user_pages())</a></p>
<ul>
<li>__get_user_pages()函数首先调用find_extend_vma()函数查找start所属的vma，find_extend_vma()相比find_vma多了一种功能就是如果查找到的vma不能包括start地址，则可以将vma进行扩展以使查找的vma能够包括start地址。</li>
<li>接下来要根据查找到的vma几种情况进行处理：<ul>
<li>vma为空即start地址查找不到对应的所属的vma，且该start地址属于gate are区域则 调用get_gate_page()<ul>
<li>找到用户空间address对应的struct page。</li>
<li>调用try_grab_page对page-&gt; refcount 进行引用计数增加，这里增加了 GUP_PIN_COUNTING_BIAS</li>
</ul>
</li>
<li>vma为空 也不属于gate area则说明在该进程空间内addr地址还未分配，直接返回。（一般调用__get_user_pages()之前，start所属的vm空间都提前已经申请好）</li>
<li>vma不为空，且vma属于huge page类型，则触发follow_hugetlb_page()为其申请一个huge page物理页，并刷新MMU</li>
<li>vma不为空，且vma属于系统默认page大小类型，则调用follow_page_mask()查看page table，查看vma是否分配了物理内存：<ul>
<li>如果没有分配，则调用faultin_page ()触发page fault流程，为其申请一个物理页</li>
<li>如果已经分配物理内存，则直接查看是否需要分配下一页</li>
</ul>
</li>
</ul>
</li>
<li>由于通过page fault流程一次只能分配一个物理页，如果nr_pages需要分配多个物理页，则需要重新循环重新依次进入上面流程。</li>
<li>特别需要注意的是，由于触发page fault流程非常耗时，特别是当nr_pages比较大时，整个锁定物理页过程非常耗时。为了在长时间循环中防止各种意外发生，函数调用了fatal_signal_pending（）和cond_resched（），分别可以获取KILL signal处理和 cpu放权触发更高优先级任务处理。</li>
</ul>
</li>
</ol>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * __get_user_pages() - pin user pages in memory</span><br><span class="hljs-comment"> * @mm:		mm_struct of target mm</span><br><span class="hljs-comment"> * @start:	starting user address</span><br><span class="hljs-comment"> * @nr_pages:	number of pages from start to pin</span><br><span class="hljs-comment"> * @gup_flags:	flags modifying pin behaviour</span><br><span class="hljs-comment"> * @pages:	array that receives pointers to the pages pinned.</span><br><span class="hljs-comment"> *		Should be at least nr_pages long. Or NULL, if caller</span><br><span class="hljs-comment"> *		only intends to ensure the pages are faulted in.</span><br><span class="hljs-comment"> * @vmas:	array of pointers to vmas corresponding to each page.</span><br><span class="hljs-comment"> *		Or NULL if the caller does not require them.</span><br><span class="hljs-comment"> * @locked:     whether we&#x27;re still with the mmap_lock held</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Returns either number of pages pinned (which may be less than the</span><br><span class="hljs-comment"> * number requested), or an error. Details about the return value:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * -- If nr_pages is 0, returns 0.</span><br><span class="hljs-comment"> * -- If nr_pages is &gt;0, but no pages were pinned, returns -errno.</span><br><span class="hljs-comment"> * -- If nr_pages is &gt;0, and some pages were pinned, returns the number of</span><br><span class="hljs-comment"> *    pages pinned. Again, this may be less than nr_pages.</span><br><span class="hljs-comment"> * -- 0 return value is possible when the fault would need to be retried.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The caller is responsible for releasing returned @pages, via put_page().</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * @vmas are valid only as long as mmap_lock is held.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Must be called with mmap_lock held.  It may be released.  See below.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * __get_user_pages walks a process&#x27;s page tables and takes a reference to</span><br><span class="hljs-comment"> * each struct page that each user address corresponds to at a given</span><br><span class="hljs-comment"> * instant. That is, it takes the page that would be accessed if a user</span><br><span class="hljs-comment"> * thread accesses the given user virtual address at that instant.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * This does not guarantee that the page exists in the user mappings when</span><br><span class="hljs-comment"> * __get_user_pages returns, and there may even be a completely different</span><br><span class="hljs-comment"> * page there in some cases (eg. if mmapped pagecache has been invalidated</span><br><span class="hljs-comment"> * and subsequently re faulted). However it does guarantee that the page</span><br><span class="hljs-comment"> * won&#x27;t be freed completely. And mostly callers simply care that the page</span><br><span class="hljs-comment"> * contains data that was valid *at some point in time*. Typically, an IO</span><br><span class="hljs-comment"> * or similar operation cannot guarantee anything stronger anyway because</span><br><span class="hljs-comment"> * locks can&#x27;t be held over the syscall boundary.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If @gup_flags &amp; FOLL_WRITE == 0, the page must not be written to. If</span><br><span class="hljs-comment"> * the page is written to, set_page_dirty (or set_page_dirty_lock, as</span><br><span class="hljs-comment"> * appropriate) must be called after the page is finished with, and</span><br><span class="hljs-comment"> * before put_page is called.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * If @locked != NULL, *@locked will be set to 0 when mmap_lock is</span><br><span class="hljs-comment"> * released by an up_read().  That can happen if @gup_flags does not</span><br><span class="hljs-comment"> * have FOLL_NOWAIT.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * A caller using such a combination of @locked and @gup_flags</span><br><span class="hljs-comment"> * must therefore hold the mmap_lock for reading only, and recognize</span><br><span class="hljs-comment"> * when it&#x27;s been released.  Otherwise, it must be held for either</span><br><span class="hljs-comment"> * reading or writing and will not be released.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * In most cases, get_user_pages or get_user_pages_fast should be used</span><br><span class="hljs-comment"> * instead of __get_user_pages. __get_user_pages should be used only if</span><br><span class="hljs-comment"> * you need some special @gup_flags.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">static</span> <span class="hljs-type">long</span> __get_user_pages(<span class="hljs-keyword">struct</span> mm_struct *mm,<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> nr_pages,<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> gup_flags, <span class="hljs-keyword">struct</span> page **pages,<br>		<span class="hljs-keyword">struct</span> vm_area_struct **vmas, <span class="hljs-type">int</span> *locked)<br>&#123;<br>	<span class="hljs-type">long</span> ret = <span class="hljs-number">0</span>, i = <span class="hljs-number">0</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">follow_page_context</span> <span class="hljs-title">ctx</span> =</span> &#123; <span class="hljs-literal">NULL</span> &#125;;<br><br>	<span class="hljs-keyword">if</span> (!nr_pages)<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>	start = untagged_addr(start);<br><br>	VM_BUG_ON(!!pages != !!(gup_flags &amp; (FOLL_GET | FOLL_PIN)));<br><br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * If FOLL_FORCE is set then do not force a full fault as the hinting</span><br><span class="hljs-comment">	 * fault information is unrelated to the reference behaviour of a task</span><br><span class="hljs-comment">	 * using the address space</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">if</span> (!(gup_flags &amp; FOLL_FORCE))<br>		gup_flags |= FOLL_NUMA;<br><br>	<span class="hljs-keyword">do</span> &#123;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> foll_flags = gup_flags;<br>		<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> page_increm;<br><br>		<span class="hljs-comment">/* first iteration or cross vma bound */</span><br>		<span class="hljs-keyword">if</span> (!vma || start &gt;= vma-&gt;vm_end) &#123;<br>			vma = find_extend_vma(mm, start);<br>			<span class="hljs-keyword">if</span> (!vma &amp;&amp; in_gate_area(mm, start)) &#123;<br>				ret = get_gate_page(mm, start &amp; PAGE_MASK,<br>						gup_flags, &amp;vma,<br>						pages ? &amp;pages[i] : <span class="hljs-literal">NULL</span>);<br>				<span class="hljs-keyword">if</span> (ret)<br>					<span class="hljs-keyword">goto</span> out;<br>				ctx.page_mask = <span class="hljs-number">0</span>;<br>				<span class="hljs-keyword">goto</span> next_page;<br>			&#125;<br><br>			<span class="hljs-keyword">if</span> (!vma) &#123;<br>				ret = -EFAULT;<br>				<span class="hljs-keyword">goto</span> out;<br>			&#125;<br>			ret = check_vma_flags(vma, gup_flags);<br>			<span class="hljs-keyword">if</span> (ret)<br>				<span class="hljs-keyword">goto</span> out;<br><br>			<span class="hljs-keyword">if</span> (is_vm_hugetlb_page(vma)) &#123;<br>				i = follow_hugetlb_page(mm, vma, pages, vmas,<br>						&amp;start, &amp;nr_pages, i,<br>						gup_flags, locked);<br>				<span class="hljs-keyword">if</span> (locked &amp;&amp; *locked == <span class="hljs-number">0</span>) &#123;<br>					<span class="hljs-comment">/*</span><br><span class="hljs-comment">					 * We&#x27;ve got a VM_FAULT_RETRY</span><br><span class="hljs-comment">					 * and we&#x27;ve lost mmap_lock.</span><br><span class="hljs-comment">					 * We must stop here.</span><br><span class="hljs-comment">					 */</span><br>					BUG_ON(gup_flags &amp; FOLL_NOWAIT);<br>					<span class="hljs-keyword">goto</span> out;<br>				&#125;<br>				<span class="hljs-keyword">continue</span>;<br>			&#125;<br>		&#125;<br>retry:<br>		<span class="hljs-comment">/*</span><br><span class="hljs-comment">		 * If we have a pending SIGKILL, don&#x27;t keep faulting pages and</span><br><span class="hljs-comment">		 * potentially allocating memory.</span><br><span class="hljs-comment">		 */</span><br>		<span class="hljs-keyword">if</span> (fatal_signal_pending(current)) &#123;<br>			ret = -EINTR;<br>			<span class="hljs-keyword">goto</span> out;<br>		&#125;<br>		cond_resched();<br><br>		page = follow_page_mask(vma, start, foll_flags, &amp;ctx);<br>		<span class="hljs-keyword">if</span> (!page || PTR_ERR(page) == -EMLINK) &#123;<br>			ret = faultin_page(vma, start, &amp;foll_flags,<br>					   PTR_ERR(page) == -EMLINK, locked);<br>			<span class="hljs-keyword">switch</span> (ret) &#123;<br>			<span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>				<span class="hljs-keyword">goto</span> retry;<br>			<span class="hljs-keyword">case</span> -EBUSY:<br>				ret = <span class="hljs-number">0</span>;<br>				fallthrough;<br>			<span class="hljs-keyword">case</span> -EFAULT:<br>			<span class="hljs-keyword">case</span> -ENOMEM:<br>			<span class="hljs-keyword">case</span> -EHWPOISON:<br>				<span class="hljs-keyword">goto</span> out;<br>			&#125;<br>			BUG();<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (PTR_ERR(page) == -EEXIST) &#123;<br>			<span class="hljs-comment">/*</span><br><span class="hljs-comment">			 * Proper page table entry exists, but no corresponding</span><br><span class="hljs-comment">			 * struct page. If the caller expects **pages to be</span><br><span class="hljs-comment">			 * filled in, bail out now, because that can&#x27;t be done</span><br><span class="hljs-comment">			 * for this page.</span><br><span class="hljs-comment">			 */</span><br>			<span class="hljs-keyword">if</span> (pages) &#123;<br>				ret = PTR_ERR(page);<br>				<span class="hljs-keyword">goto</span> out;<br>			&#125;<br><br>			<span class="hljs-keyword">goto</span> next_page;<br>		&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (IS_ERR(page)) &#123;<br>			ret = PTR_ERR(page);<br>			<span class="hljs-keyword">goto</span> out;<br>		&#125;<br>		<span class="hljs-keyword">if</span> (pages) &#123;<br>			pages[i] = page;<br>			flush_anon_page(vma, page, start);<br>			flush_dcache_page(page);<br>			ctx.page_mask = <span class="hljs-number">0</span>;<br>		&#125;<br>next_page:<br>		<span class="hljs-keyword">if</span> (vmas) &#123;<br>			vmas[i] = vma;<br>			ctx.page_mask = <span class="hljs-number">0</span>;<br>		&#125;<br>		page_increm = <span class="hljs-number">1</span> + (~(start &gt;&gt; PAGE_SHIFT) &amp; ctx.page_mask);<br>		<span class="hljs-keyword">if</span> (page_increm &gt; nr_pages)<br>			page_increm = nr_pages;<br>		i += page_increm;<br>		start += page_increm * PAGE_SIZE;<br>		nr_pages -= page_increm;<br>	&#125; <span class="hljs-keyword">while</span> (nr_pages);<br>out:<br>	<span class="hljs-keyword">if</span> (ctx.pgmap)<br>		put_dev_pagemap(ctx.pgmap);<br>	<span class="hljs-keyword">return</span> i ? i : ret;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/RDMA/">#RDMA</a>
      
        <a href="/tags/libRXE/">#libRXE</a>
      
        <a href="/tags/Soft-ROCE/">#Soft-ROCE</a>
      
        <a href="/tags/libibverbs/">#libibverbs</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>RDMA-RoCEv2 ibv_reg_mr 分析</div>
      <div>https://gwzlchn.github.io/202208/rdma-stack-02/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Zelin Wang</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年8月25日</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>更新于</div>
          <div>2022年10月16日</div>
        </div>
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/202210/rdma-stack-03/" title="RXE中的定时器">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">RXE中的定时器</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/202207/rdma-stack-01/" title="RDMA Stack实现分析">
                        <span class="hidden-mobile">RDMA Stack实现分析</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://lib.baomitu.com/gitalk/1.7.2/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"92499b3e9ca46e054919","clientSecret":"eef0bc1146a28cdb3d17fd4cf149158cab4ffa2f","repo":"gwzlchn.github.io","owner":"Gwzlchn","admin":["Gwzlchn"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: 'e14562f203eddf8d23c66e3f840592a5'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
      <div class="col-lg-7 mx-auto nopadding-x-md">
        <div class="container custom mx-auto">
          <script type="text/javascript" src="//rf.revolvermaps.com/0/0/6.js?i=5lzo9y8g750&amp;m=7&amp;c=baff00&amp;cr1=ff007e&amp;f=arial&amp;l=0&amp;bv=40" async="async"></script>
        </div>
      </div>
    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Powered by Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>With Fluid Theme</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
