

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=light>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico">
  <link rel="icon" href="/img/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#080000">
  <meta name="author" content="Zelin Wang">
  <meta name="keywords" content="">
  
    <meta name="description" content="希望通过这篇文章来梳理  libibverbs提供的用户态Verbs API是如何进行设备操作&#x2F;数据通信的，以Soft-RXE实现为例。 基于kernel: 5.19-rc1 基于rdma-core: v34.0  RDMA Stack的内核支持 参考：https:&#x2F;&#x2F;www.kernel.org&#x2F;doc&#x2F;html&#x2F;latest&#x2F;translations&#x2F;zh_CN&#x2F;infin">
<meta property="og:type" content="article">
<meta property="og:title" content="RDMA Stack实现分析">
<meta property="og:url" content="https://gwzlchn.github.io/202207/rdma-stack-01/index.html">
<meta property="og:site_name" content="Zelin&#39;s Blog">
<meta property="og:description" content="希望通过这篇文章来梳理  libibverbs提供的用户态Verbs API是如何进行设备操作&#x2F;数据通信的，以Soft-RXE实现为例。 基于kernel: 5.19-rc1 基于rdma-core: v34.0  RDMA Stack的内核支持 参考：https:&#x2F;&#x2F;www.kernel.org&#x2F;doc&#x2F;html&#x2F;latest&#x2F;translations&#x2F;zh_CN&#x2F;infin">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gwzlchn.github.io/img/rdma-stack-01/mlx_ofed_stack.png">
<meta property="og:image" content="https://gwzlchn.github.io/img/rdma-stack-01/ibv_create_qp.png">
<meta property="article:published_time" content="2022-07-04T14:30:11.000Z">
<meta property="article:modified_time" content="2022-07-05T02:48:23.086Z">
<meta property="article:author" content="Zelin Wang">
<meta property="article:tag" content="RDMA">
<meta property="article:tag" content="libRXE">
<meta property="article:tag" content="Soft-ROCE">
<meta property="article:tag" content="libibverbs">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://gwzlchn.github.io/img/rdma-stack-01/mlx_ofed_stack.png">
  
  
  
  <title>RDMA Stack实现分析 - Zelin&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"gwzlchn.github.io","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"vyfV0Jz8OincT54vffevrlx0-gzGzoHsz","app_key":"abuQhfiaX9zRJg6PYac65qfa","server_url":"https://vyfv0jz8.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 50vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Zelin&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/banner.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="RDMA Stack实现分析"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-07-04 22:30" pubdate>
          星期一, 七月 4日 2022, 10:30 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          22k 字
        
      </span>
    

    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">RDMA Stack实现分析</h1>
            
            
              <div class="markdown-body">
                
                <p>希望通过这篇文章来梳理</p>
<ol>
<li>libibverbs提供的用户态Verbs API是如何进行设备操作&#x2F;数据通信的，以Soft-RXE实现为例。</li>
<li>基于kernel: 5.19-rc1</li>
<li>基于rdma-core: v34.0</li>
</ol>
<h2 id="RDMA-Stack的内核支持"><a href="#RDMA-Stack的内核支持" class="headerlink" title="RDMA Stack的内核支持"></a>RDMA Stack的内核支持</h2><ol>
<li><p>参考：<a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/latest/translations/zh_CN/infiniband/user_verbs.html">https://www.kernel.org/doc/html/latest/translations/zh_CN&#x2F;infiniband&#x2F;user_verbs.html</a></p>
</li>
<li><p>RDMA Stack分为控制面和数据面，图1中给出了Mellanox MLX5 RDMA stack 涉及到的用户态库以及内核模块。图二中给出了一个控制面API在用户态libibverbs与内核之间的调用关系。</p>
<ol>
<li>控制面：<ol>
<li><code>ib_uverbs.ko</code> 内核模块会对每个IB设备生成一个字符设备文件。通常的形式为 <code>/dev/infiniband/uverbs%d</code> ，用户态程序通过ioctl对字符设备进行属性的读写。</li>
<li>libibverbs 中的控制面相关Verbs API利用了<code>ib_uverbs.ko</code> 暴露出来的字符设备对RDMA设备操作。</li>
</ol>
</li>
<li>数据面<ol>
<li>通常是通过直接写入<code>mmap()</code>到用户空间的硬件寄存器来完成 的，没有系统调用或上下文切换到内核。</li>
</ol>
</li>
</ol>
<p> <img src="/img/rdma-stack-01/mlx_ofed_stack.png" srcset="/img/loading.gif" lazyload alt="Mellanox OFED stack arch."><br> <a target="_blank" rel="noopener" href="https://docs.nvidia.com/networking/display/OFEDv501000/Introduction">图1: Mellanox OFED stack arch.</a>)</p>
<p> <img src="/img/rdma-stack-01/ibv_create_qp.png" srcset="/img/loading.gif" lazyload><br> [图2: libibverbs中的控制面API与内核的调用关系: 以ibv_create_qp为例]</p>
</li>
</ol>
<h2 id="1-ibv-open-device"><a href="#1-ibv-open-device" class="headerlink" title="1. ibv_open_device"></a>1. ibv_open_device</h2><p>用户态打开IB设备的API</p>
<ol>
<li>参考：<a target="_blank" rel="noopener" href="https://www.rdmamojo.com/2012/06/29/ibv_open_device/">RDMAmojo: ibv_open_device</a></li>
</ol>
<h3 id="1-1-RXE调用栈分析"><a href="#1-1-RXE调用栈分析" class="headerlink" title="1.1 RXE调用栈分析"></a>1.1 RXE调用栈分析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">ibv_open_device<br>|-- verbs_open_device<br>	|-- open_cdev<br>	|-- rxe_alloc_context<br>		|-- verbs_init_and_alloc_context<br>			|-- verbs_init_context<br>		|-- ibv_cmd_get_context<br>		|-- verbs_set_ops<br></code></pre></td></tr></table></figure>

<ol>
<li><p>open_cdev</p>
<p> 会打开uverbs字符设备，文件描述符保存在cmd_fd中</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rdma-core/libibverbs/device.c</span><br>cmd_fd = open_cdev(verbs_device-&gt;sysfs-&gt;sysfs_name,<br>				   verbs_device-&gt;sysfs-&gt;sysfs_cdev);<br><br><span class="hljs-comment">// rdma-core/util/open_cdev.c</span><br><span class="hljs-comment">// in open_cdev funcion</span><br>fd = open(<span class="hljs-string">&quot;/dev/infiniband/uverbs%d&quot;</span>, O_RDWR | O_CLOEXEC)<br></code></pre></td></tr></table></figure>
</li>
<li><p>rxe_alloc_context</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rdma-core/libibverbs/device.c</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * cmd_fd ownership is transferred into alloc_context, if it fails</span><br><span class="hljs-comment"> * then it closes cmd_fd and returns NULL</span><br><span class="hljs-comment"> */</span><br>context_ex = verbs_device-&gt;ops-&gt;alloc_context(device, cmd_fd, private_data);<br><br><span class="hljs-comment">// rdma-core/providers/rxe/rxe.c</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> struct verbs_context *<span class="hljs-title">rxe_alloc_context</span><span class="hljs-params">(struct ibv_device *ibdev,</span></span><br><span class="hljs-params"><span class="hljs-function">					       <span class="hljs-keyword">int</span> cmd_fd,</span></span><br><span class="hljs-params"><span class="hljs-function">					       <span class="hljs-keyword">void</span> *private_data)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_context</span> *<span class="hljs-title">context</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ibv_get_context</span> <span class="hljs-title">cmd</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ib_uverbs_get_context_resp</span> <span class="hljs-title">resp</span>;</span><br><br>	context = verbs_init_and_alloc_context(ibdev, cmd_fd, context, ibv_ctx,<br>					       RDMA_DRIVER_RXE);<br>...<br>	ibv_cmd_get_context(&amp;context-&gt;ibv_ctx, &amp;cmd, <span class="hljs-keyword">sizeof</span>(cmd),<br>				&amp;resp, <span class="hljs-keyword">sizeof</span>(resp))<br>...<br><br>	verbs_set_ops(&amp;context-&gt;ibv_ctx, &amp;rxe_ctx_ops);<br>...<br>&#125;<br><br></code></pre></td></tr></table></figure>
</li>
<li><p>verbs_init_and_alloc_context</p>
<ol>
<li><code>&amp;((typeof(context))((void *)0))-&gt;ibv_ctx</code>,  类似于<code>offset_of</code> 宏，计算<code>ibv_ctx</code>在<code>rxe_context</code> 结构体内偏移</li>
</ol>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rdma-core/providers/rxe/rxe.h</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_context</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">verbs_context</span>	<span class="hljs-title">ibv_ctx</span>;</span><br>&#125;;<br><br><span class="hljs-comment">// rdma-core/providers/rxe/rxe.c</span><br><span class="hljs-comment">// expand macro</span><br>context = ((typeof(context))_verbs_init_and_alloc_context(<br>	ibdev, <br>	cmd_fd, <br>	<span class="hljs-keyword">sizeof</span>(*context),<br>	&amp;((typeof(context))((<span class="hljs-keyword">void</span> *)<span class="hljs-number">0</span>))-&gt;ibv_ctx, <br>	(RDMA_DRIVER_RXE)))<br><br><span class="hljs-comment">// rdma-core/libibverbs/device.c</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Allocate and initialize a context structure. This is called to create the</span><br><span class="hljs-comment"> * driver wrapper, and context_offset is the number of bytes into the wrapper</span><br><span class="hljs-comment"> * structure where the verbs_context starts.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">void</span> *_verbs_init_and_alloc_context(struct ibv_device *device, <span class="hljs-keyword">int</span> cmd_fd,<br>				    <span class="hljs-keyword">size_t</span> alloc_size,<br>				    struct verbs_context *context_offset,<br>				    <span class="hljs-keyword">uint32_t</span> driver_id)<br>&#123;<br>	<span class="hljs-keyword">void</span> *drv_context;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">verbs_context</span> *<span class="hljs-title">context</span>;</span><br><br>	drv_context = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, alloc_size);<br>...<br>	context = drv_context + (<span class="hljs-keyword">uintptr_t</span>)context_offset;<br>	verbs_init_context(context, device, cmd_fd, driver_id)<br>...<br>	<span class="hljs-keyword">return</span> drv_context;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>verbs_init_context</p>
<ol>
<li><code>context-&gt;cmd_fd = cmd_fd;</code> 记录uverbs设备文件的描述符</li>
<li>用<code>verbs_dummy_ops</code>初始化 <code>ibv_context-&gt;ibv_context_ops</code>  回调函数结构体</li>
</ol>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rdma-core/libibverbs/device.c</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">verbs_init_context</span><span class="hljs-params">(struct verbs_context *context_ex,</span></span><br><span class="hljs-params"><span class="hljs-function">		       struct ibv_device *device, <span class="hljs-keyword">int</span> cmd_fd,</span></span><br><span class="hljs-params"><span class="hljs-function">		       <span class="hljs-keyword">uint32_t</span> driver_id)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ibv_context</span> *<span class="hljs-title">context</span> =</span> &amp;context_ex-&gt;context;<br><br>	ibverbs_device_hold(device);<br><br>	context-&gt;device = device;<br>	context-&gt;cmd_fd = cmd_fd;<br>	context-&gt;async_fd = <span class="hljs-number">-1</span>;<br>	pthread_mutex_init(&amp;context-&gt;mutex, <span class="hljs-literal">NULL</span>);<br><br>	context_ex-&gt;context.abi_compat = __VERBS_ABI_IS_EXTENDED;<br>	context_ex-&gt;sz = <span class="hljs-keyword">sizeof</span>(*context_ex);<br><br>	context_ex-&gt;priv = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1</span>, <span class="hljs-keyword">sizeof</span>(*context_ex-&gt;priv));<br>...<br>	context_ex-&gt;priv-&gt;driver_id = driver_id;<br>	verbs_set_ops(context_ex, &amp;verbs_dummy_ops);<br>	context_ex-&gt;priv-&gt;use_ioctl_write = has_ioctl_write(context);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>ibv_cmd_get_context</p>
<ol>
<li>ioctl 传递给kernel的参数都会封装在ibv_command_buffer 结构体中，这里声明arg buffer</li>
</ol>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// in rdma-core/providers/rxe/rxe.c, call function</span><br>ibv_cmd_get_context(&amp;context-&gt;ibv_ctx, &amp;cmd, <span class="hljs-keyword">sizeof</span>(cmd),<br>			&amp;resp, <span class="hljs-keyword">sizeof</span>(resp));<br><br><span class="hljs-comment">// rdma-core/libibverbs/cmd_device.c</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">ibv_cmd_get_context</span><span class="hljs-params">(struct verbs_context *context_ex,</span></span><br><span class="hljs-params"><span class="hljs-function">			struct ibv_get_context *cmd, <span class="hljs-keyword">size_t</span> cmd_size,</span></span><br><span class="hljs-params"><span class="hljs-function">			struct ib_uverbs_get_context_resp *resp,</span></span><br><span class="hljs-params"><span class="hljs-function">			<span class="hljs-keyword">size_t</span> resp_size)</span></span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-comment">//	DECLARE_CMD_BUFFER_COMPAT(cmdb, UVERBS_OBJECT_DEVICE,</span><br><span class="hljs-comment">//				  UVERBS_METHOD_GET_CONTEXT, cmd, cmd_size,</span><br><span class="hljs-comment">//				  resp, resp_size);</span><br>	<span class="hljs-comment">// expands macro</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ibv_command_buffer</span> <span class="hljs-title">cmdb</span>[((<span class="hljs-title">sizeof</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title">ibv_command_buffer</span>) +</span><br><span class="hljs-class">					 <span class="hljs-title">sizeof</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title">ib_uverbs_attr</span>) * (__<span class="hljs-title">cmdbtotal</span>) +</span><br><span class="hljs-class">					 <span class="hljs-title">sizeof</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title">ibv_command_buffer</span>) - 1) /</span><br><span class="hljs-class">					<span class="hljs-title">sizeof</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title">ibv_command_buffer</span>))];</span><br>	<span class="hljs-keyword">return</span> cmd_get_context(context_ex, cmdb);<br>&#125;<br><br></code></pre></td></tr></table></figure>
</li>
<li><p>verbs_set_ops </p>
<ol>
<li>将<code>verbs_context</code> 结构体中的<code>verbs_context</code> 中的回调函数，设置为rxe声明的回调函数（默认为dummy_ops）</li>
<li>这里不太清楚为什么<code>verbs_context</code>内部的<code>verbs_ex_private</code> 结构体又保存了一份回调函数</li>
</ol>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// in rdma-core/providers/rxe/rxe.c, call function</span><br>verbs_set_ops(&amp;context-&gt;ibv_ctx, &amp;rxe_ctx_ops);<br><br><span class="hljs-comment">// rdma-core/libibverbs/dummy_ops.c</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">verbs_set_ops</span><span class="hljs-params">(struct verbs_context *vctx,</span></span><br><span class="hljs-params"><span class="hljs-function">		   <span class="hljs-keyword">const</span> struct verbs_context_ops *ops)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">verbs_ex_private</span> *<span class="hljs-title">priv</span> =</span> vctx-&gt;priv;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ibv_context_ops</span> *<span class="hljs-title">ctx</span> =</span> &amp;vctx-&gt;context.ops;<br>...<br>	<span class="hljs-comment">// expand macro</span><br>	<span class="hljs-keyword">if</span> (ops-&gt;alloc_dm) &#123;<br>		priv-&gt;ops.alloc_dm = ops-&gt;alloc_dm;<br>		(vctx)-&gt;alloc_dm = ops-&gt;alloc_dm;<br>	&#125;<br>... <br>	<br></code></pre></td></tr></table></figure>
</li>
<li><p>总结ibv_open_device</p>
<ol>
<li>分配context结构体，打开uverbs字符设备</li>
<li>设置用于传递ioctl参数的 arg buffer</li>
<li>设置回调函数，这些回调函数会被ibv_xxx Verbs调用</li>
</ol>
</li>
</ol>
<h2 id="2-ibv-create-qp"><a href="#2-ibv-create-qp" class="headerlink" title="2. ibv_create_qp"></a>2. ibv_create_qp</h2><p>Verbs</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.rdmamojo.com/2012/12/21/ibv_create_qp/">RDMAmojo: ibv_create_qp</a></li>
</ol>
<h3 id="2-1-RXE调用栈分析"><a href="#2-1-RXE调用栈分析" class="headerlink" title="2.1 RXE调用栈分析"></a>2.1 RXE调用栈分析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">ibv_create_qp<br>|-- rxe_create_qp<br>    |-- ibv_cmd_create_qp<br>		|-- ibv_icmd_create_qp<br>			|-- execute_ioctl_fallback<br>				|-- execute_ioctl<br>					|-- kernel: rxe_create_qp<br>		|-- map_queue_pair<br></code></pre></td></tr></table></figure>

<ol>
<li><p>ibv_create_qp</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rdma-core/libibverbs/verbs.c</span><br>LATEST_SYMVER_FUNC(ibv_create_qp, <span class="hljs-number">1</span>_1, <span class="hljs-string">&quot;IBVERBS_1.1&quot;</span>,<br>		   struct ibv_qp *,                        <span class="hljs-comment">// return type</span><br>		   struct ibv_pd *pd,                      <span class="hljs-comment">// arg1</span><br>		   struct ibv_qp_init_attr *qp_init_attr)  <span class="hljs-comment">// arg2</span><br>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ibv_qp</span> *<span class="hljs-title">qp</span> =</span> get_ops(pd-&gt;context)-&gt;create_qp(pd, qp_init_attr);<br><br>	<span class="hljs-keyword">return</span> qp;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>rxe_create_qp</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rdma-core/providers/rxe/rxe.c</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> struct ibv_qp *<span class="hljs-title">rxe_create_qp</span><span class="hljs-params">(struct ibv_pd *ibpd,</span></span><br><span class="hljs-params"><span class="hljs-function">				    struct ibv_qp_init_attr *attr)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ibv_create_qp</span> <span class="hljs-title">cmd</span> =</span> &#123;&#125;;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">urxe_create_qp_resp</span> <span class="hljs-title">resp</span> =</span> &#123;&#125;;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_qp</span> *<span class="hljs-title">qp</span>;</span><br>	<span class="hljs-keyword">int</span> ret;<br><br>...<br>	ret = ibv_cmd_create_qp(ibpd, &amp;qp-&gt;vqp.qp, attr, &amp;cmd, <span class="hljs-keyword">sizeof</span>(cmd),<br>				&amp;resp.ibv_resp, <span class="hljs-keyword">sizeof</span>(resp));<br>...<br>	ret = map_queue_pair(ibpd-&gt;context-&gt;cmd_fd, qp, attr,<br>			     &amp;resp.drv_payload);<br><br>...<br>&#125;<br></code></pre></td></tr></table></figure>
<ol>
<li>其中 ibv_create_qp&#x2F;urxe_create_qp_resp 这两个结构体由宏声明，分别将二者展开后 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rdma-core/cmake-build-debug/include/infiniband/kern-abi.h </span><br>DECLARE_CMD(IB_USER_VERBS_CMD_CREATE_CQ, ibv_create_cq, ib_uverbs_create_cq);<br><br><span class="hljs-comment">// expands macro</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ibv_create_qp</span> &#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ib_uverbs_cmd_hdr</span> <span class="hljs-title">hdr</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>		_STRUCT_ib_uverbs_create_qp;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ib_uverbs_create_qp</span> <span class="hljs-title">core_payload</span>;</span><br>	&#125;;<br>&#125;;<br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ibv_create_qp</span> _<span class="hljs-title">ABI_REQ_STRUCT_IB_USER_VERBS_CMD_CREATE_QP</span>;</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ib_uverbs_create_qp</span> _<span class="hljs-title">KABI_REQ_STRUCT_IB_USER_VERBS_CMD_CREATE_QP</span>;</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ib_uverbs_create_qp_resp</span></span><br><span class="hljs-class">	_<span class="hljs-title">KABI_RESP_STRUCT_IB_USER_VERBS_CMD_CREATE_QP</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> &#123;</span> _ABI_ALIGN_IB_USER_VERBS_CMD_CREATE_QP = <span class="hljs-number">4</span> &#125;;<br></code></pre></td></tr></table></figure>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-comment">// rdma-core/providers/rxe/rxe-abi.h</span><br>DECLARE_DRV_CMD(urxe_create_qp, IB_USER_VERBS_CMD_CREATE_QP,<br>		empty, rxe_create_qp_resp);<br><br><span class="hljs-comment">// expands macro</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">urxe_create_qp</span> &#123;</span><br>	_ABI_REQ_STRUCT_IB_USER_VERBS_CMD_CREATE_QP ibv_cmd;<br>	<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span>&#125;;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">empty</span> <span class="hljs-title">drv_payload</span>;</span><br>	&#125;;<br>&#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">urxe_create_qp_resp</span> &#123;</span><br>	_KABI_RESP_STRUCT_IB_USER_VERBS_CMD_CREATE_QP ibv_resp;<br>	<span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mminfo</span> <span class="hljs-title">rq_mi</span>;</span><br>			<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mminfo</span> <span class="hljs-title">sq_mi</span>;</span><br>		&#125;;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_create_qp_resp</span> <span class="hljs-title">drv_payload</span>;</span><br>	&#125;;<br>&#125;;<br></code></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>ibv_cmd_create_qp</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rdma-core/libibverbs/cmd_qp.c</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">ibv_cmd_create_qp</span><span class="hljs-params">(struct ibv_pd *pd,</span></span><br><span class="hljs-params"><span class="hljs-function">		      struct ibv_qp *qp, struct ibv_qp_init_attr *attr,</span></span><br><span class="hljs-params"><span class="hljs-function">		      struct ibv_create_qp *cmd, <span class="hljs-keyword">size_t</span> cmd_size,</span></span><br><span class="hljs-params"><span class="hljs-function">		      struct ib_uverbs_create_qp_resp *resp, <span class="hljs-keyword">size_t</span> resp_size)</span></span><br><span class="hljs-function"></span>&#123;<br>	DECLARE_CMD_BUFFER_COMPAT(cmdb, UVERBS_OBJECT_QP,<br>				  UVERBS_METHOD_QP_CREATE, cmd, cmd_size, resp,<br>				  resp_size);<br><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ibv_qp_init_attr_ex</span> <span class="hljs-title">attr_ex</span> =</span> &#123;&#125;;<br>	<span class="hljs-keyword">int</span> ret;<br><br>	attr_ex.qp_context = attr-&gt;qp_context;<br>	attr_ex.send_cq = attr-&gt;send_cq;<br>	attr_ex.recv_cq = attr-&gt;recv_cq;<br>	attr_ex.srq = attr-&gt;srq;<br>	attr_ex.cap = attr-&gt;cap;<br>	attr_ex.qp_type = attr-&gt;qp_type;<br>	attr_ex.sq_sig_all = attr-&gt;sq_sig_all;<br>	attr_ex.comp_mask = IBV_QP_INIT_ATTR_PD;<br>	attr_ex.pd = pd;<br>	ret = ibv_icmd_create_qp(pd-&gt;context, <span class="hljs-literal">NULL</span>, qp, &amp;attr_ex, cmdb);<br>	<span class="hljs-keyword">if</span> (!ret)<br>		<span class="hljs-built_in">memcpy</span>(&amp;attr-&gt;cap, &amp;attr_ex.cap, <span class="hljs-keyword">sizeof</span>(attr_ex.cap));<br><br>	<span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>ibv_icmd_create_qp</p>
<ol>
<li>libibverbs使用了两套与内核通信的方式：传统的write方式，以及ioctl方式。</li>
<li>如果当前的ib device context不支持ioctl方式与内核暴露的字符设备通信的话，则需要fallback回write方式<ol>
<li>可以参考之前版本的libibverbs对应实现：<a target="_blank" rel="noopener" href="https://github.com/hustcat/rdma-core/blob/v15/libibverbs/cmd.c#L1063">https://github.com/hustcat/rdma-core/blob/v15/libibverbs/cmd.c#L1063</a></li>
</ol>
</li>
<li>_CMD_BIT(cmd_name)   宏作用：把verbs_context_ops看成bitmap，每个回调函数占一个bit，计算传入的cmd_name占哪个bit<ol>
<li>sizeof(void*) 由编译时target platform决定，amd64下值等于8</li>
</ol>
</li>
</ol>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rdma-core/libibverbs/cmd_qp.c</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">ibv_icmd_create_qp</span><span class="hljs-params">(struct ibv_context *context,</span></span><br><span class="hljs-params"><span class="hljs-function">			      struct verbs_qp *vqp,</span></span><br><span class="hljs-params"><span class="hljs-function">			      struct ibv_qp *qp_in,</span></span><br><span class="hljs-params"><span class="hljs-function">			      struct ibv_qp_init_attr_ex *attr_ex,</span></span><br><span class="hljs-params"><span class="hljs-function">			      struct ibv_command_buffer *link)</span> </span>&#123;<br>...<br>execute_ioctl_fallback(context, create_qp, cmdb, &amp;ret)<br>...<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">write_fallback</span> _<span class="hljs-title">execute_ioctl_fallback</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title">ibv_context</span> *<span class="hljs-title">ctx</span>,</span><br><span class="hljs-class">					    <span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">cmd_bit</span>,</span><br><span class="hljs-class">					    <span class="hljs-keyword">struct</span> <span class="hljs-title">ibv_command_buffer</span> *<span class="hljs-title">cmdb</span>,</span><br><span class="hljs-class">					    <span class="hljs-title">int</span> *<span class="hljs-title">ret</span>);</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> execute_ioctl_fallback(ctx, cmd_name, cmdb, ret)                       \</span><br><span class="hljs-meta">	_execute_ioctl_fallback(ctx, _CMD_BIT(cmd_name), cmdb, ret)</span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _CMD_BIT(cmd_name)                                                     \</span><br><span class="hljs-meta">	(offsetof(struct verbs_context_ops, cmd_name) / sizeof(void *))</span><br><br></code></pre></td></tr></table></figure>
</li>
<li><p>_execute_ioctl_fallback</p>
<ol>
<li>检查当前设备是否可以使用ioctl方式进行操作，是的话直接ioctl传给内核响应命令，否则fallback回调用函数</li>
</ol>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rdma-core/libibverbs/cmd_fallback.c</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Used to support callers that have a fallback to the old write ABI</span><br><span class="hljs-comment"> * interface.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">write_fallback</span> _<span class="hljs-title">execute_ioctl_fallback</span>(<span class="hljs-keyword">struct</span> <span class="hljs-title">ibv_context</span> *<span class="hljs-title">ctx</span>,</span><br><span class="hljs-class">					    <span class="hljs-title">unsigned</span> <span class="hljs-title">int</span> <span class="hljs-title">cmd_bit</span>,</span><br><span class="hljs-class">					    <span class="hljs-keyword">struct</span> <span class="hljs-title">ibv_command_buffer</span> *<span class="hljs-title">cmdb</span>,</span><br><span class="hljs-class">					    <span class="hljs-title">int</span> *<span class="hljs-title">ret</span>)</span><br><span class="hljs-class">&#123;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">verbs_ex_private</span> *<span class="hljs-title">priv</span> =</span> get_priv(ctx);<br><br>	<span class="hljs-keyword">if</span> (bitmap_test_bit(priv-&gt;unsupported_ioctls, cmd_bit))<br>		<span class="hljs-keyword">return</span> _check_legacy(cmdb, ret);<br><br>	*ret = execute_ioctl(ctx, cmdb);<br>...<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>kernel: rxe_create_qp</p>
<ol>
<li><p>在内核新建一个QP：根据QPN号hash后得到对应的src port，用于填充要发送的UDP报文</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// linux-kernel/rust-kernel/drivers/infiniband/sw/rxe/rxe_verbs.c</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">rxe_create_qp</span><span class="hljs-params">(struct ib_qp *ibqp, struct ib_qp_init_attr *init,</span></span><br><span class="hljs-params"><span class="hljs-function">			 struct ib_udata *udata)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">int</span> err;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_dev</span> *<span class="hljs-title">rxe</span> =</span> to_rdev(ibqp-&gt;device);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_pd</span> *<span class="hljs-title">pd</span> =</span> to_rpd(ibqp-&gt;pd);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_qp</span> *<span class="hljs-title">qp</span> =</span> to_rqp(ibqp);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_create_qp_resp</span> __<span class="hljs-title">user</span> *<span class="hljs-title">uresp</span> =</span> <span class="hljs-literal">NULL</span>;<br>	<span class="hljs-keyword">if</span> (udata) &#123;<br>		<span class="hljs-keyword">if</span> (udata-&gt;outlen &lt; <span class="hljs-keyword">sizeof</span>(*uresp))<br>			<span class="hljs-keyword">return</span> -EINVAL;<br>		uresp = udata-&gt;outbuf;<br>	&#125;<br>	err = rxe_qp_chk_init(rxe, init);<br>...<br>		qp-&gt;is_user = <span class="hljs-literal">true</span>;<br>...<br>	err = rxe_add_to_pool(&amp;rxe-&gt;qp_pool, qp);<br>...<br>	err = rxe_qp_from_init(rxe, qp, pd, init, uresp, ibqp-&gt;pd, udata);<br>...<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>rxe_qp_init_req </p>
<ul>
<li>在 rxe_queue_init 函数中申请一段连续的虚拟地址空间，用作SQ buffer</li>
<li>将SQ buffer的地址+大小设置为QP中RQ的mmap info</li>
<li>根据QPN号hash后得到对应的src port，用于填充UDP报文</li>
</ul>
</li>
<li><p>rxe_qp_init_resp</p>
<ul>
<li>在 rxe_queue_init 函数中申请一段连续的虚拟地址空间，用作RQ buffer</li>
<li>将RQ buffer的地址+大小设置为QP中RQ的mmap info</li>
</ul>
</li>
</ol>
</li>
<li><p>kernel: rxe_create_mmap_info</p>
<ol>
<li>将QP中记录的SQ&#x2F;RQ的mmap info，传回userspace，userspace根据内核指定的offset+size做mmap之后，使得kernel与userspace可以共享QP内存空间。</li>
</ol>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// linux-kernel/rust-kernel/drivers/infiniband/sw/rxe/rxe_mmap.c</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Allocate information for rxe_mmap</span><br><span class="hljs-comment"> */</span><br><span class="hljs-function">struct rxe_mmap_info *<span class="hljs-title">rxe_create_mmap_info</span><span class="hljs-params">(struct rxe_dev *rxe, u32 size,</span></span><br><span class="hljs-params"><span class="hljs-function">					   struct ib_udata *udata, <span class="hljs-keyword">void</span> *obj)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_mmap_info</span> *<span class="hljs-title">ip</span>;</span><br>	ip = kmalloc(<span class="hljs-keyword">sizeof</span>(*ip), GFP_KERNEL);<br>...<br>	ip-&gt;info.offset = rxe-&gt;mmap_offset;<br>	ip-&gt;info.size = size;<br>	ip-&gt;context =<br>		container_of(udata, struct uverbs_attr_bundle, driver_udata)<br>			-&gt;context;<br>...<br>	ip-&gt;obj = obj;<br>	kref_init(&amp;ip-&gt;ref);<br>	<span class="hljs-keyword">return</span> ip;<br>&#125;<br></code></pre></td></tr></table></figure>
<p> 最后<code>ip-&gt;info</code> 会被传给<code>userspace</code>，作为<code>rxe_create_qp_resp</code>
 </p>
</li>
<li><p>map_queue_pair</p>
<ol>
<li><code>map_queue_pair</code> 中第一个参数是<code>ibpd-&gt;context-&gt;cmd_fd</code>， 字符设备的文件描述符。</li>
<li>mmap 的offset + size 是由kernel传到的用户空间的resp设置</li>
</ol>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// in rdma-core/providers/rxe/rxe.c, call function</span><br>ret = map_queue_pair(ibpd-&gt;context-&gt;cmd_fd, qp, attr,<br>		     &amp;resp.drv_payload);<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">map_queue_pair</span><span class="hljs-params">(<span class="hljs-keyword">int</span> cmd_fd, struct rxe_qp *qp,</span></span><br><span class="hljs-params"><span class="hljs-function">			  struct ibv_qp_init_attr *attr,</span></span><br><span class="hljs-params"><span class="hljs-function">			  struct rxe_create_qp_resp *resp)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span> (attr-&gt;srq) &#123;<br>		qp-&gt;rq.max_sge = <span class="hljs-number">0</span>;<br>		qp-&gt;rq.<span class="hljs-built_in">queue</span> = <span class="hljs-literal">NULL</span>;<br>		qp-&gt;rq_mmap_info.size = <span class="hljs-number">0</span>;<br>	&#125; <span class="hljs-keyword">else</span> &#123;<br>		qp-&gt;rq.max_sge = attr-&gt;cap.max_recv_sge;<br>		qp-&gt;rq.<span class="hljs-built_in">queue</span> = mmap(<span class="hljs-literal">NULL</span>, resp-&gt;rq_mi.size, PROT_READ | PROT_WRITE,<br>				    MAP_SHARED,<br>				    cmd_fd, resp-&gt;rq_mi.offset);<br>		<span class="hljs-keyword">if</span> ((<span class="hljs-keyword">void</span> *)qp-&gt;rq.<span class="hljs-built_in">queue</span> == MAP_FAILED)<br>			<span class="hljs-keyword">return</span> errno;<br><br>		qp-&gt;rq_mmap_info = resp-&gt;rq_mi;<br>		pthread_spin_init(&amp;qp-&gt;rq.lock, PTHREAD_PROCESS_PRIVATE);<br>	&#125;<br><br>	qp-&gt;sq.max_sge = attr-&gt;cap.max_send_sge;<br>	qp-&gt;sq.max_inline = attr-&gt;cap.max_inline_data;<br>	qp-&gt;sq.<span class="hljs-built_in">queue</span> = mmap(<span class="hljs-literal">NULL</span>, resp-&gt;sq_mi.size, PROT_READ | PROT_WRITE,<br>			    MAP_SHARED,<br>			    cmd_fd, resp-&gt;sq_mi.offset);<br>...<br>	qp-&gt;sq_mmap_info = resp-&gt;sq_mi;<br>	pthread_spin_init(&amp;qp-&gt;sq.lock, PTHREAD_PROCESS_PRIVATE);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure>
</li>
<li><p>总结ibv_create_qp</p>
<ol>
<li>libRXE部分通过ioctl&#x2F;write的方式请求kernel</li>
<li>kernel创建SQ&#x2F;RQ两端缓冲区，将地址+大小传回用户态</li>
<li>libRXE根据传回信息，映射相同的地址到用户态，使得内核与用户态共享Queue Pair的地址空间。</li>
</ol>
</li>
</ol>
<h2 id="3-ibv-post-send"><a href="#3-ibv-post-send" class="headerlink" title="3. ibv_post_send"></a>3. ibv_post_send</h2><p>Verbs</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://www.rdmamojo.com/2013/01/26/ibv_post_send/">RDMAmojo: ibv_post_send</a></li>
<li>将一组链式的ibv_send_wr发送到QP中的Send Queue中</li>
</ol>
<h3 id="3-1-RXE调用栈分析"><a href="#3-1-RXE调用栈分析" class="headerlink" title="3.1 RXE调用栈分析"></a>3.1 RXE调用栈分析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">ibv_post_send<br>|-- rxe_post_send<br>	|-- post_one_send<br>	|-- post_send_db<br>		|-- rxe_post_send<br>			|-- rxe_requester<br></code></pre></td></tr></table></figure>

<ol>
<li><p>rxe_post_send</p>
<ul>
<li>将wr_list链表中的work request依次放到QP send queue buffer中</li>
<li>如果有失败的，则将bad_wr指向第一个失败的work request，bad_wr会返回给应用程序</li>
<li>所有WR放到Send Queue之后，敲一下door bell通知kernel</li>
</ul>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rdma-core/providers/rxe/rxe.c</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">rxe_post_send</span><span class="hljs-params">(struct ibv_qp *ibqp,</span></span><br><span class="hljs-params"><span class="hljs-function">			 struct ibv_send_wr *wr_list,</span></span><br><span class="hljs-params"><span class="hljs-function">			 struct ibv_send_wr **bad_wr)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">int</span> rc = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">int</span> err;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_qp</span> *<span class="hljs-title">qp</span> =</span> to_rqp(ibqp);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_wq</span> *<span class="hljs-title">sq</span> =</span> &amp;qp-&gt;sq;<br><br>	<span class="hljs-keyword">if</span> (!bad_wr)<br>		<span class="hljs-keyword">return</span> EINVAL;<br><br>	*bad_wr = <span class="hljs-literal">NULL</span>;<br>...<br>	pthread_spin_lock(&amp;sq-&gt;lock);<br><br>	<span class="hljs-keyword">while</span> (wr_list) &#123;<br>		rc = post_one_send(qp, sq, wr_list);<br>		<span class="hljs-keyword">if</span> (rc) &#123;<br>			*bad_wr = wr_list;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br><br>		wr_list = wr_list-&gt;next;<br>	&#125;<br><br>	pthread_spin_unlock(&amp;sq-&gt;lock);<br><br>	err =  post_send_db(ibqp);<br>	<span class="hljs-keyword">return</span> err ? err : rc;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>post_one_send</p>
<ul>
<li>对于RXE而言，libRXE中的<code>post_one_send</code>作为生产者，向Send Queue中放置Work request。</li>
<li>读当前Send queue空闲区域起始地址需要原子操作（避免使用锁）</li>
<li>更新 <code>producer_index</code> 指针需要原子操作</li>
</ul>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rdma-core/providers/rxe/rxe.c</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">post_one_send</span><span class="hljs-params">(struct rxe_qp *qp, struct rxe_wq *sq,</span></span><br><span class="hljs-params"><span class="hljs-function">			 struct ibv_send_wr *ibwr)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">int</span> err;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_send_wqe</span> *<span class="hljs-title">wqe</span>;</span><br>	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> length = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">int</span> i;<br><br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; ibwr-&gt;num_sge; i++)<br>		length += ibwr-&gt;sg_list[i].length;<br><br>	err = validate_send_wr(qp, ibwr, length);<br>	<span class="hljs-keyword">if</span> (err) &#123;<br>		verbs_err(verbs_get_ctx(qp-&gt;vqp.qp.context),<br>			  <span class="hljs-string">&quot;validate send failed\n&quot;</span>);<br>		<span class="hljs-keyword">return</span> err;<br>	&#125;<br><br>	wqe = (struct rxe_send_wqe *)producer_addr(sq-&gt;<span class="hljs-built_in">queue</span>);<br><br>	err = init_send_wqe(qp, sq, ibwr, length, wqe);<br>	<span class="hljs-keyword">if</span> (err)<br>		<span class="hljs-keyword">return</span> err;<br><br>	<span class="hljs-keyword">if</span> (queue_full(sq-&gt;<span class="hljs-built_in">queue</span>))<br>		<span class="hljs-keyword">return</span> -ENOMEM;<br><br>	advance_producer(sq-&gt;<span class="hljs-built_in">queue</span>);<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>init_send_wqe</p>
<ul>
<li>这个函数比较容易理解，就是将一个WR中所有<code>sg_list</code> 拷贝到wqe buffer中，kernel再去根据SGList读内存。（RXE这里没有DMA操作）</li>
<li>如果设置了 IBV_SEND_INLINE，则在这里直接拷贝数据本身到wqe buffer中</li>
</ul>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rdma-core/providers/rxe/rxe.c</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">init_send_wqe</span><span class="hljs-params">(struct rxe_qp *qp, struct rxe_wq *sq,</span></span><br><span class="hljs-params"><span class="hljs-function">		  struct ibv_send_wr *ibwr, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> length,</span></span><br><span class="hljs-params"><span class="hljs-function">		  struct rxe_send_wqe *wqe)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">int</span> num_sge = ibwr-&gt;num_sge;<br>	<span class="hljs-keyword">int</span> i;<br>	<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> opcode = ibwr-&gt;opcode;<br><br>	convert_send_wr(qp, &amp;wqe-&gt;wr, ibwr);<br><br>	<span class="hljs-keyword">if</span> (qp_type(qp) == IBV_QPT_UD) &#123;<br>		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_ah</span> *<span class="hljs-title">ah</span> =</span> to_rah(ibwr-&gt;wr.ud.ah);<br><br>		<span class="hljs-keyword">if</span> (!ah-&gt;ah_num)<br>			<span class="hljs-comment">/* old kernels only */</span><br>			<span class="hljs-built_in">memcpy</span>(&amp;wqe-&gt;wr.wr.ud.av, &amp;ah-&gt;av, <span class="hljs-keyword">sizeof</span>(struct rxe_av));<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (ibwr-&gt;send_flags &amp; IBV_SEND_INLINE) &#123;<br>		<span class="hljs-keyword">uint8_t</span> *inline_data = wqe-&gt;dma.inline_data;<br><br>		<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; num_sge; i++) &#123;<br>			<span class="hljs-built_in">memcpy</span>(inline_data,<br>			       (<span class="hljs-keyword">uint8_t</span> *)(<span class="hljs-keyword">long</span>)ibwr-&gt;sg_list[i].addr,<br>			       ibwr-&gt;sg_list[i].length);<br>			inline_data += ibwr-&gt;sg_list[i].length;<br>		&#125;<br>	&#125; <span class="hljs-keyword">else</span><br>		<span class="hljs-built_in">memcpy</span>(wqe-&gt;dma.sge, ibwr-&gt;sg_list,<br>		       num_sge*<span class="hljs-keyword">sizeof</span>(struct ibv_sge));<br><br>	<span class="hljs-keyword">if</span> ((opcode == IBV_WR_ATOMIC_CMP_AND_SWP)<br>	    || (opcode == IBV_WR_ATOMIC_FETCH_AND_ADD))<br>		wqe-&gt;iova	= ibwr-&gt;wr.atomic.remote_addr;<br>	<span class="hljs-keyword">else</span><br>		wqe-&gt;iova	= ibwr-&gt;wr.rdma.remote_addr;<br><br>	wqe-&gt;dma.length		= length;<br>	wqe-&gt;dma.resid		= length;<br>	wqe-&gt;dma.num_sge	= num_sge;<br>	wqe-&gt;dma.cur_sge	= <span class="hljs-number">0</span>;<br>	wqe-&gt;dma.sge_offset	= <span class="hljs-number">0</span>;<br>	wqe-&gt;state		= <span class="hljs-number">0</span>;<br>	wqe-&gt;ssn		= qp-&gt;ssn++;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>post_send_db</p>
<ul>
<li>敲doorbell 在RXE这里变为使用write的方式通知kernel</li>
</ul>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rdma-core/providers/rxe/rxe.c</span><br><span class="hljs-comment">/* send a null post send as a doorbell */</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">post_send_db</span><span class="hljs-params">(struct ibv_qp *ibqp)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ibv_post_send</span> <span class="hljs-title">cmd</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ib_uverbs_post_send_resp</span> <span class="hljs-title">resp</span>;</span><br><br>	cmd.hdr.command	= IB_USER_VERBS_CMD_POST_SEND;<br>	cmd.hdr.in_words = <span class="hljs-keyword">sizeof</span>(cmd) / <span class="hljs-number">4</span>;<br>	cmd.hdr.out_words = <span class="hljs-keyword">sizeof</span>(resp) / <span class="hljs-number">4</span>;<br>	cmd.response	= (<span class="hljs-keyword">uintptr_t</span>)&amp;resp;<br>	cmd.qp_handle	= ibqp-&gt;handle;<br>	cmd.wr_count	= <span class="hljs-number">0</span>;<br>	cmd.sge_count	= <span class="hljs-number">0</span>;<br>	cmd.wqe_size	= <span class="hljs-keyword">sizeof</span>(struct ibv_send_wr);<br><br>	<span class="hljs-keyword">if</span> (write(ibqp-&gt;context-&gt;cmd_fd, &amp;cmd, <span class="hljs-keyword">sizeof</span>(cmd)) != <span class="hljs-keyword">sizeof</span>(cmd))<br>		<span class="hljs-keyword">return</span> errno;<br><br>	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>kernel: rxe_post_send</p>
<ol>
<li>libRXE将传递给内核的命令设置为 IB_USER_VERBS_CMD_POST_SEND</li>
<li><code>ib_uverbs_post_send</code> -&gt; <code>ib_device-&gt;post_send</code> -&gt; <code>rxe_post_send</code> -&gt; <code>rxe_requester</code> -&gt; <code>ip_local_out</code></li>
<li>kernel在初始化Send Queue的时候，将 qp-&gt;req.task 回调函数注册为<code>rxe_requester</code></li>
</ol>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel/drivers/infiniband/sw/rxe/rxe_verbs.c</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">rxe_post_send</span><span class="hljs-params">(struct ib_qp *ibqp, <span class="hljs-keyword">const</span> struct ib_send_wr *wr,</span></span><br><span class="hljs-params"><span class="hljs-function">			 <span class="hljs-keyword">const</span> struct ib_send_wr **bad_wr)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_qp</span> *<span class="hljs-title">qp</span> =</span> to_rqp(ibqp);<br>...<br>	<span class="hljs-keyword">if</span> (qp-&gt;is_user) &#123;<br>		<span class="hljs-comment">/* Utilize process context to do protocol processing */</span><br>		rxe_run_task(&amp;qp-&gt;req.task, <span class="hljs-number">0</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>...<br>&#125;<br><br><span class="hljs-comment">// kernel/drivers/infiniband/sw/rxe/rxe_qp.c</span><br><span class="hljs-comment">// in func rxe_qp_init_req</span><br>rxe_init_task(rxe, &amp;qp-&gt;req.task, qp,<br>		      rxe_requester, <span class="hljs-string">&quot;req&quot;</span>);<br>rxe_init_task(rxe, &amp;qp-&gt;comp.task, qp,<br>		      rxe_completer, <span class="hljs-string">&quot;comp&quot;</span>);<br></code></pre></td></tr></table></figure>
</li>
<li><p>kernel: rxe_requester</p>
<ul>
<li>rxe_requester从rxe_qp队列取出wqe，生成对应的skb_buff，然后下发给对应的rxe_dev设备后发送IP包</li>
</ul>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel/drivers/infiniband/sw/rxe/rxe_req.c</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">rxe_requester</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_qp</span> *<span class="hljs-title">qp</span> =</span> (struct rxe_qp *)arg;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_pkt_info</span> <span class="hljs-title">pkt</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sk_buff</span> *<span class="hljs-title">skb</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_send_wqe</span> *<span class="hljs-title">wqe</span>;</span><br>...<br>	wqe = req_next_wqe(qp); <br>	opcode = next_opcode(qp, wqe, wqe-&gt;wr.opcode);<br>	mask = rxe_opcode[opcode].mask;<br>	<span class="hljs-comment">// read payload from mem or inline</span><br>...<br>	<span class="hljs-comment">// set ib packet</span><br>	pkt.rxe = rxe;<br>	pkt.opcode = opcode;<br>	pkt.qp = qp;<br>	pkt.psn = qp-&gt;req.psn;<br>	pkt.mask = rxe_opcode[opcode].mask;<br>	pkt.wqe = wqe;<br>	av = rxe_get_av(&amp;pkt, &amp;ah);<br>...<br>	<span class="hljs-comment">// set sk buffer</span><br>	skb = init_req_packet(qp, wqe, opcode, payload, &amp;pkt);<br>...<br>	ret = finish_packet(qp, av, wqe, &amp;pkt, skb, payload);<br>	ret = rxe_xmit_packet(qp, &amp;pkt, skb);<br>...<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">rxe_xmit_packet</span><span class="hljs-params">(struct rxe_qp *qp, struct rxe_pkt_info *pkt,</span></span><br><span class="hljs-params"><span class="hljs-function">		    struct sk_buff *skb)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">int</span> err;<br>	<span class="hljs-keyword">int</span> is_request = pkt-&gt;mask &amp; RXE_REQ_MASK;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_dev</span> *<span class="hljs-title">rxe</span> =</span> to_rdev(qp-&gt;ibqp.device);<br>...<br>	rxe_icrc_generate(skb, pkt);<br><br>	<span class="hljs-keyword">if</span> (pkt-&gt;mask &amp; RXE_LOOPBACK_MASK)<br>		err = rxe_loopback(skb, pkt);<br>	<span class="hljs-keyword">else</span><br>		err = rxe_send(skb, pkt);<br>...<br>	<span class="hljs-keyword">if</span> ((qp_type(qp) != IB_QPT_RC) &amp;&amp;<br>	    (pkt-&gt;mask &amp; RXE_END_MASK)) &#123;<br>		pkt-&gt;wqe-&gt;state = wqe_state_done;<br>		rxe_run_task(&amp;qp-&gt;comp.task, <span class="hljs-number">1</span>);<br>	&#125;<br><br>	rxe_counter_inc(rxe, RXE_CNT_SENT_PKTS);<br>...<br>&#125;<br><br></code></pre></td></tr></table></figure></li>
</ol>
<h3 id="4-2-MLX5调用栈分析"><a href="#4-2-MLX5调用栈分析" class="headerlink" title="4.2 MLX5调用栈分析"></a>4.2 MLX5调用栈分析</h3><ol>
<li>将Work Request链表写入mmap到用户态地址空间的QP send queue buffer中<ul>
<li>这里通过MMIO的方式访问位于PCI上的内存区间</li>
</ul>
</li>
<li>全部Work Request写完后，敲一下硬件的doorbell<ul>
<li><p>将一个ctrl结构体的地址通过MMIO的方式写入硬件的doorbell寄存器</p>
<p>  &#x2F;&#x2F; rdma-core&#x2F;providers&#x2F;mlx5&#x2F;qp.c</p>
<p>  <code>mmio_write64_be(bf-&gt;reg + bf-&gt;offset, *(__be64 *)ctrl);</code></p>
</li>
</ul>
</li>
</ol>
<h2 id="4-ibv-post-recv"><a href="#4-ibv-post-recv" class="headerlink" title="4. ibv_post_recv"></a>4. ibv_post_recv</h2><h3 id="4-1-RXE调用栈分析"><a href="#4-1-RXE调用栈分析" class="headerlink" title="4.1 RXE调用栈分析"></a>4.1 RXE调用栈分析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">ibv_post_recv<br>|-- rxe_post_recv<br>	|-- rxe_post_one_recv<br></code></pre></td></tr></table></figure>

<ol>
<li><p>rxe_post_recv</p>
<ul>
<li>和post_send大同小异，向Recv Queue中写入recv work request</li>
</ul>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rdma-core/providers/rxe/rxe.c</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">rxe_post_recv</span><span class="hljs-params">(struct ibv_qp *ibqp,</span></span><br><span class="hljs-params"><span class="hljs-function">			 struct ibv_recv_wr *recv_wr,</span></span><br><span class="hljs-params"><span class="hljs-function">			 struct ibv_recv_wr **bad_wr)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">int</span> rc = <span class="hljs-number">0</span>;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_qp</span> *<span class="hljs-title">qp</span> =</span> to_rqp(ibqp);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_wq</span> *<span class="hljs-title">rq</span> =</span> &amp;qp-&gt;rq;<br>...<br>	pthread_spin_lock(&amp;rq-&gt;lock);<br><br>	<span class="hljs-keyword">while</span> (recv_wr) &#123;<br>		rc = rxe_post_one_recv(rq, recv_wr);<br>		<span class="hljs-keyword">if</span> (rc) &#123;<br>			*bad_wr = recv_wr;<br>			<span class="hljs-keyword">break</span>;<br>		&#125;<br><br>		recv_wr = recv_wr-&gt;next;<br>	&#125;<br><br>	pthread_spin_unlock(&amp;rq-&gt;lock);<br><br>	<span class="hljs-keyword">return</span> rc;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>rxe_post_one_recv</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rdma-core/providers/rxe/rxe.c</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">rxe_post_one_recv</span><span class="hljs-params">(struct rxe_wq *rq, struct ibv_recv_wr *recv_wr)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">int</span> i;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_recv_wqe</span> *<span class="hljs-title">wqe</span>;</span><br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_queue_buf</span> *<span class="hljs-title">q</span> =</span> rq-&gt;<span class="hljs-built_in">queue</span>;<br>	<span class="hljs-keyword">int</span> length = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">int</span> rc = <span class="hljs-number">0</span>;<br>...<br>	wqe = (struct rxe_recv_wqe *)producer_addr(q);<br><br>	wqe-&gt;wr_id = recv_wr-&gt;wr_id;<br>	wqe-&gt;num_sge = recv_wr-&gt;num_sge;<br><br>	<span class="hljs-built_in">memcpy</span>(wqe-&gt;dma.sge, recv_wr-&gt;sg_list,<br>	       wqe-&gt;num_sge*<span class="hljs-keyword">sizeof</span>(*wqe-&gt;dma.sge));<br><br>	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; wqe-&gt;num_sge; i++)<br>		length += wqe-&gt;dma.sge[i].length;<br><br>	wqe-&gt;dma.length = length;<br>	wqe-&gt;dma.resid = length;<br>	wqe-&gt;dma.cur_sge = <span class="hljs-number">0</span>;<br>	wqe-&gt;dma.num_sge = wqe-&gt;num_sge;<br>	wqe-&gt;dma.sge_offset = <span class="hljs-number">0</span>;<br><br>	advance_producer(q);<br><br>out:<br>	<span class="hljs-keyword">return</span> rc;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h2 id="5-ibv-poll-cq"><a href="#5-ibv-poll-cq" class="headerlink" title="5. ibv_poll_cq"></a>5. ibv_poll_cq</h2><h3 id="5-1-RXE调用栈分析"><a href="#5-1-RXE调用栈分析" class="headerlink" title="5.1 RXE调用栈分析"></a>5.1 RXE调用栈分析</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">ibv_poll_cq<br>|-- rxe_poll_cq<br></code></pre></td></tr></table></figure>

<ol>
<li><p>rxe_poll_cq</p>
<ul>
<li>从CQ buffer中读取多个Work Completions，写入到应用程序传递下来的 wc buffer中</li>
</ul>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// rdma-core/providers/rxe/rxe.c</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">rxe_poll_cq</span><span class="hljs-params">(struct ibv_cq *ibcq, <span class="hljs-keyword">int</span> ne, struct ibv_wc *wc)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_cq</span> *<span class="hljs-title">cq</span> =</span> to_rcq(ibcq);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_queue_buf</span> *<span class="hljs-title">q</span>;</span><br>	<span class="hljs-keyword">int</span> npolled;<br>	<span class="hljs-keyword">uint8_t</span> *src;<br><br>	pthread_spin_lock(&amp;cq-&gt;lock);<br>	q = cq-&gt;<span class="hljs-built_in">queue</span>;<br><br>	<span class="hljs-keyword">for</span> (npolled = <span class="hljs-number">0</span>; npolled &lt; ne; ++npolled, ++wc) &#123;<br>		<span class="hljs-keyword">if</span> (queue_empty(q))<br>			<span class="hljs-keyword">break</span>;<br><br>		src = consumer_addr(q);<br>		<span class="hljs-built_in">memcpy</span>(wc, src, <span class="hljs-keyword">sizeof</span>(*wc));<br>		advance_consumer(q);<br>	&#125;<br><br>	pthread_spin_unlock(&amp;cq-&gt;lock);<br>	<span class="hljs-keyword">return</span> npolled;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<h2 id="6-RXE对于收包的处理"><a href="#6-RXE对于收包的处理" class="headerlink" title="6. RXE对于收包的处理"></a>6. RXE对于收包的处理</h2><ol>
<li><p>UDP隧道建立时设置回调函数</p>
<ul>
<li>rdma_rxe module在初始化的时候，会创建一个UDP tunnel，其回调函数被设置为rxe_udp_encap_rec</li>
</ul>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel/drivers/infiniband/sw/rxe/rxe_net.c</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> struct socket *<span class="hljs-title">rxe_setup_udp_tunnel</span><span class="hljs-params">(struct net *net, __be16 port,</span></span><br><span class="hljs-params"><span class="hljs-function">					   <span class="hljs-keyword">bool</span> ipv6)</span></span><br><span class="hljs-function"></span>&#123;<br>...<br>	udp_cfg.local_udp_port = port;<br><br>	<span class="hljs-comment">/* Create UDP socket */</span><br>	err = udp_sock_create(net, &amp;udp_cfg, &amp;sock);<br>...<br>	tnl_cfg.encap_type = <span class="hljs-number">1</span>;<br>	tnl_cfg.encap_rcv = rxe_udp_encap_recv;<br><br>	<span class="hljs-comment">/* Setup UDP tunnel */</span><br>	setup_udp_tunnel_sock(net, sock, &amp;tnl_cfg);<br><br>	<span class="hljs-keyword">return</span> sock;<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>rxe_udp_encap_recv → rxe_rcv</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel/drivers/infiniband/sw/rxe/rxe_recv.c</span><br><span class="hljs-comment">/* rxe_rcv is called from the interface driver */</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">rxe_rcv</span><span class="hljs-params">(struct sk_buff *skb)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">int</span> err;<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_pkt_info</span> *<span class="hljs-title">pkt</span> =</span> SKB_TO_PKT(skb);<br>	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rxe_dev</span> *<span class="hljs-title">rxe</span> =</span> pkt-&gt;rxe;<br>...<br>	pkt-&gt;opcode = bth_opcode(pkt);<br>	pkt-&gt;psn = bth_psn(pkt);<br>	pkt-&gt;qp = <span class="hljs-literal">NULL</span>;<br>	pkt-&gt;mask |= rxe_opcode[pkt-&gt;opcode].mask;<br>...<br>	err = rxe_icrc_check(skb, pkt);<br>...<br>	rxe_counter_inc(rxe, RXE_CNT_RCVD_PKTS);<br><br>	<span class="hljs-keyword">if</span> (unlikely(bth_qpn(pkt) == IB_MULTICAST_QPN))<br>		rxe_rcv_mcast_pkt(rxe, skb);<br>	<span class="hljs-keyword">else</span><br>		rxe_rcv_pkt(pkt, skb);<br><br>	<span class="hljs-keyword">return</span>;<br>...<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">rxe_rcv_pkt</span><span class="hljs-params">(struct rxe_pkt_info *pkt, struct sk_buff *skb)</span></span><br><span class="hljs-function"></span>&#123;<br>	<span class="hljs-keyword">if</span> (pkt-&gt;mask &amp; RXE_REQ_MASK)<br>		rxe_resp_queue_pkt(pkt-&gt;qp, skb);<br>	<span class="hljs-keyword">else</span><br>		rxe_comp_queue_pkt(pkt-&gt;qp, skb);<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>rxe_responder</p>
<ul>
<li><p>如果收到的包是RDMA请求的话（RDMA_READ&#x2F;RDMA_WRITE&#x2F;RDMA_SEND_REQ）</p>
</li>
<li><p>如果收到包的状态是RESPST_COMPLETE的话，说明一次RDMA通信完成，RXE kernel模块会在CQ中写入一个WR</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// kernel/drivers/infiniband/sw/rxe/rxe_resp.c </span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">enum</span> resp_states <span class="hljs-title">do_complete</span><span class="hljs-params">(struct rxe_qp *qp,</span></span><br><span class="hljs-params"><span class="hljs-function">				    struct rxe_pkt_info *pkt)</span></span><br><span class="hljs-function"></span>&#123;...&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/RDMA/">#RDMA</a>
      
        <a href="/tags/libRXE/">#libRXE</a>
      
        <a href="/tags/Soft-ROCE/">#Soft-ROCE</a>
      
        <a href="/tags/libibverbs/">#libibverbs</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>RDMA Stack实现分析</div>
      <div>https://gwzlchn.github.io/202207/rdma-stack-01/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Zelin Wang</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年7月4日</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>更新于</div>
          <div>2022年7月5日</div>
        </div>
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/202206/rust-for-linux-01/" title="体验rust-for-linux">
                        <span class="hidden-mobile">体验rust-for-linux</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="gitalk-container"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#gitalk-container', function() {
      Fluid.utils.createCssLink('/css/gitalk.css')
      Fluid.utils.createScript('https://lib.baomitu.com/gitalk/1.7.2/gitalk.min.js', function() {
        var options = Object.assign(
          {"clientID":"92499b3e9ca46e054919","clientSecret":"eef0bc1146a28cdb3d17fd4cf149158cab4ffa2f","repo":"gwzlchn.github.io","owner":"Gwzlchn","admin":["Gwzlchn"],"language":"zh-CN","labels":["Gitalk"],"perPage":10,"pagerDirection":"last","distractionFreeMode":false,"createIssueManually":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token"},
          {
            id: '2d53430e4a0dbf69cd995492b5269c85'
          }
        )
        var gitalk = new Gitalk(options);
        gitalk.render('gitalk-container');
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
      <div class="col-lg-7 mx-auto nopadding-x-md">
        <div class="container custom mx-auto">
          <script type="text/javascript" src="//rf.revolvermaps.com/0/0/6.js?i=5lzo9y8g750&amp;m=7&amp;c=baff00&amp;cr1=ff007e&amp;f=arial&amp;l=0&amp;bv=40" async="async"></script>
        </div>
      </div>
    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Powered by Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>With Fluid Theme</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
